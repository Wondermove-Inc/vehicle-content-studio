import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Introduction/Testing Guide" />

# Testing Guide

shadcn-storybook-registryì˜ í…ŒìŠ¤íŠ¸ ì „ëµê³¼ ì‘ì„± ê°€ì´ë“œì…ë‹ˆë‹¤.

## Testing Strategy

ì´ í”„ë¡œì íŠ¸ëŠ” 3ê°€ì§€ í…ŒìŠ¤íŠ¸ ë ˆì´ì–´ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

- **Play Functions**: Storybook ë‚´ì—ì„œ ì¸í„°ë™ì…˜ í…ŒìŠ¤íŠ¸
- **Vitest Unit Tests**: ì»´í¬ë„ŒíŠ¸ ë¡œì§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- **Playwright Browser Tests**: ì‹¤ì œ ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œ E2E í…ŒìŠ¤íŠ¸

## Play Functions

Storybook 9ì˜ **Play Functions**ëŠ” ì»´í¬ë„ŒíŠ¸ ì¸í„°ë™ì…˜ì„ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

### Basic Structure

```typescript
import type { Meta, StoryObj } from "@storybook/nextjs-vite";
import { expect, userEvent, within, waitFor } from "storybook/test";
import { Button } from "@/components/ui/button";

const meta: Meta<typeof Button> = {
  title: "ui/Button",
  component: Button,
  tags: ["autodocs"],
};

export default meta;
type Story = StoryObj<typeof meta>;

/**
 * ë²„íŠ¼ í´ë¦­ ì‹œ ìƒíƒœê°€ ë³€ê²½ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
 */
export const ShouldToggleOnClick: Story = {
  tags: ["!dev", "!autodocs"], // ğŸ‘ˆ í…ŒìŠ¤íŠ¸ ì „ìš© ìŠ¤í† ë¦¬
  render: () => {
    const [clicked, setClicked] = React.useState(false);
    return (
      <Button onClick={() => setClicked(!clicked)}>
        {clicked ? "Clicked" : "Click me"}
      </Button>
    );
  },
  play: async ({ canvasElement }) => {
    const canvas = within(canvasElement);

    // ğŸ¯ ëª©ì : ë²„íŠ¼ í´ë¦­ ì‹œ í…ìŠ¤íŠ¸ê°€ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸
    const button = canvas.getByRole("button", { name: /click me/i });
    await expect(button).toBeInTheDocument();

    // ë²„íŠ¼ í´ë¦­
    await userEvent.click(button);

    // í…ìŠ¤íŠ¸ ë³€ê²½ í™•ì¸
    await waitFor(() => {
      expect(button).toHaveTextContent("Clicked");
    });
  },
};
```

### Story Naming Convention

Play function ìŠ¤í† ë¦¬ëŠ” **`Should...`** íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:

- âœ… `ShouldOpenDialog`
- âœ… `ShouldSelectDate`
- âœ… `ShouldValidateForm`
- âŒ `TestDialog`
- âŒ `CheckValidation`

### Tags Configuration

```typescript
tags: ["!dev", "!autodocs"];
```

- `!dev`: Dev modeì—ì„œ ìˆ¨ê¹€
- `!autodocs`: Autodocs í˜ì´ì§€ì—ì„œ ì œì™¸

### Common Patterns

#### 1. Button Interactions

```typescript
// ë²„íŠ¼ ì°¾ê¸°
const button = canvas.getByRole("button", { name: /submit/i });

// í´ë¦­
await userEvent.click(button);

// ìƒíƒœ í™•ì¸
await expect(button).toBeDisabled();
```

#### 2. Form Inputs

```typescript
// Input ì°¾ê¸°
const input = canvas.getByRole("textbox", { name: /email/i });

// í…ìŠ¤íŠ¸ ì…ë ¥
await userEvent.type(input, "test@example.com");

// ê°’ í™•ì¸
await expect(input).toHaveValue("test@example.com");
```

#### 3. Dialog/Popover Opening

```typescript
// íŠ¸ë¦¬ê±° í´ë¦­
await userEvent.click(canvas.getByRole("button", { name: /open/i }));

// Dialog ì—´ë¦¼ í™•ì¸
await waitFor(async () => {
  const dialog = await canvas.findByRole("dialog");
  await expect(dialog).toBeInTheDocument();
});
```

#### 4. Select/Combobox

```typescript
// Select ì—´ê¸°
await userEvent.click(canvas.getByRole("combobox"));

// ì˜µì…˜ ì„ íƒ
const option = canvas.getByRole("option", { name: /option 1/i });
await userEvent.click(option);

// ì„ íƒ í™•ì¸
await expect(canvas.getByRole("combobox")).toHaveTextContent("Option 1");
```

#### 5. Keyboard Navigation

```typescript
// Tab í‚¤
await userEvent.tab();

// Enter í‚¤
await userEvent.keyboard("{Enter}");

// Escape í‚¤
await userEvent.keyboard("{Escape}");

// Arrow keys
await userEvent.keyboard("{ArrowDown}");
```

### í•œêµ­ì–´ ì£¼ì„ í•„ìˆ˜

ëª¨ë“  Play functionì—ëŠ” `ğŸ¯ ëª©ì ` ì£¼ì„ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:

```typescript
play: async ({ canvasElement }) => {
  const canvas = within(canvasElement);

  // ğŸ¯ ëª©ì : Form ì œì¶œ ì‹œ validation ì—ëŸ¬ê°€ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
  const submitButton = canvas.getByRole("button", { name: /submit/i });
  await userEvent.click(submitButton);

  // Validation ì—ëŸ¬ í™•ì¸
  await waitFor(() => {
    expect(canvas.getByText(/required/i)).toBeInTheDocument();
  });
},
```

### Testing Async Operations

```typescript
// Loading ìƒíƒœ í…ŒìŠ¤íŠ¸
await userEvent.click(submitButton);

// Loading spinner í‘œì‹œ í™•ì¸
await expect(canvas.getByRole("status")).toBeInTheDocument();

// ì™„ë£Œ í›„ ì„±ê³µ ë©”ì‹œì§€ í™•ì¸
await waitFor(
  () => {
    expect(canvas.getByText(/success/i)).toBeInTheDocument();
  },
  { timeout: 3000 },
);
```

## Vitest Unit Tests

**Vitest**ë¡œ ì»´í¬ë„ŒíŠ¸ ë¡œì§ì„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

### Running Tests

```bash
# ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
npm run test

# ìœ ë‹› í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
npm run test:unit

# Watch mode
npm run test:unit -- --watch
```

### Test File Structure

```typescript
import { describe, it, expect, vi } from "vitest";
import { render, screen } from "@testing-library/react";
import { Button } from "@/components/ui/button";

describe("Button", () => {
  it("should render with default variant", () => {
    render(<Button>Click me</Button>);
    const button = screen.getByRole("button");
    expect(button).toHaveClass("bg-primary");
  });

  it("should call onClick handler", () => {
    const handleClick = vi.fn();
    render(<Button onClick={handleClick}>Click me</Button>);

    const button = screen.getByRole("button");
    button.click();

    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it("should be disabled when disabled prop is true", () => {
    render(<Button disabled>Click me</Button>);
    const button = screen.getByRole("button");
    expect(button).toBeDisabled();
  });
});
```

### Mocking

```typescript
// Mock í•¨ìˆ˜
const mockFn = vi.fn();

// Mock ëª¨ë“ˆ
vi.mock("@/lib/utils", () => ({
  cn: vi.fn((...classes) => classes.join(" ")),
}));

// Timer mock
vi.useFakeTimers();
vi.advanceTimersByTime(1000);
vi.useRealTimers();
```

## Playwright Browser Tests

**Playwright**ë¡œ ì‹¤ì œ ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

### Running Tests

```bash
# Storybook í…ŒìŠ¤íŠ¸ ì‹¤í–‰
npm run test:storybook

# Storybook Test Runner
npm run storybook:test
```

### Test Configuration

Storybook Test RunnerëŠ” ëª¨ë“  Play functionì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.

```typescript
// .storybook/test-runner.ts
import type { TestRunnerConfig } from "@storybook/test-runner";

const config: TestRunnerConfig = {
  async postVisit(page, context) {
    // ì¶”ê°€ ê²€ì¦ ë¡œì§
    const element = page.locator("#root");
    await expect(element).toBeVisible();
  },
};

export default config;
```

## Accessibility Testing

**A11y addon**ìœ¼ë¡œ ì ‘ê·¼ì„±ì„ ìë™ ê²€ì¦í•©ë‹ˆë‹¤.

### Configuration

```typescript
// .storybook/preview.ts
export const parameters = {
  a11y: {
    config: {
      rules: [
        {
          id: "color-contrast",
          enabled: true,
        },
      ],
    },
    options: {
      checks: { "color-contrast": { options: { noScroll: true } } },
      restoreScroll: true,
    },
    manual: false,
  },
};
```

### Testing WCAG 2.1 AA Compliance

ëª¨ë“  ì»´í¬ë„ŒíŠ¸ëŠ” ë‹¤ìŒì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤:

- âœ… **Color Contrast**: ìµœì†Œ 4.5:1 ë¹„ìœ¨
- âœ… **Keyboard Navigation**: Tab, Enter, Escape, Arrow keys
- âœ… **Screen Reader**: ARIA labels, roles, states
- âœ… **Focus Management**: ë…¼ë¦¬ì  í¬ì»¤ìŠ¤ ìˆœì„œ
- âœ… **Semantic HTML**: `<button>`, `<input>`, `<label>` ë“±

### Keyboard Navigation Testing

```typescript
export const ShouldNavigateWithKeyboard: Story = {
  tags: ["!dev", "!autodocs"],
  play: async ({ canvasElement }) => {
    const canvas = within(canvasElement);

    // ğŸ¯ ëª©ì : í‚¤ë³´ë“œë¡œ ëª¨ë“  ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œì— ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸

    // Tabìœ¼ë¡œ ì²« ë²ˆì§¸ ìš”ì†Œì— í¬ì»¤ìŠ¤
    await userEvent.tab();
    const firstButton = canvas.getAllByRole("button")[0];
    await expect(firstButton).toHaveFocus();

    // Tabìœ¼ë¡œ ë‹¤ìŒ ìš”ì†Œë¡œ ì´ë™
    await userEvent.tab();
    const secondButton = canvas.getAllByRole("button")[1];
    await expect(secondButton).toHaveFocus();

    // Enterë¡œ ë²„íŠ¼ í™œì„±í™”
    await userEvent.keyboard("{Enter}");

    // Escapeë¡œ ë‹«ê¸°
    await userEvent.keyboard("{Escape}");
  },
};
```

## Best Practices

### 1. Test Isolation

ê° í…ŒìŠ¤íŠ¸ëŠ” ë…ë¦½ì ì´ì–´ì•¼ í•©ë‹ˆë‹¤:

```typescript
// âœ… Good: ë…ë¦½ì ì¸ í…ŒìŠ¤íŠ¸
export const ShouldOpenDialog: Story = {
  render: () => {
    const [open, setOpen] = React.useState(false);
    return <Dialog open={open} onOpenChange={setOpen} />;
  },
  play: async ({ canvasElement }) => {
    // í…ŒìŠ¤íŠ¸ ë¡œì§
  },
};

// âŒ Bad: ì™¸ë¶€ ìƒíƒœ ì˜ì¡´
let globalState = false;
export const ShouldOpenDialog: Story = {
  play: async () => {
    globalState = true; // ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ì— ì˜í–¥
  },
};
```

### 2. Clear Assertions

ëª…í™•í•œ assertionì„ ì‚¬ìš©í•˜ì„¸ìš”:

```typescript
// âœ… Good: ëª…í™•í•œ assertion
await expect(button).toHaveTextContent("Submit");
await expect(input).toHaveValue("test@example.com");
await expect(dialog).toBeVisible();

// âŒ Bad: ë¶ˆëª…í™•í•œ assertion
await expect(button.textContent).toBe("Submit"); // DOM API ì§ì ‘ ì‚¬ìš©
```

### 3. WaitFor for Async

ë¹„ë™ê¸° ë™ì‘ì€ `waitFor`ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

```typescript
// âœ… Good: waitFor ì‚¬ìš©
await waitFor(() => {
  expect(canvas.getByText(/success/i)).toBeInTheDocument();
});

// âŒ Bad: ê³ ì •ëœ timeout
await new Promise((resolve) => setTimeout(resolve, 1000));
```

### 4. User-Centric Queries

ì‚¬ìš©ì ê´€ì ì˜ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

```typescript
// âœ… Good: ì—­í•  ê¸°ë°˜ ì¿¼ë¦¬
canvas.getByRole("button", { name: /submit/i });
canvas.getByRole("textbox", { name: /email/i });
canvas.getByLabelText(/password/i);

// âŒ Bad: êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ ì¿¼ë¦¬
canvas.getByClassName("btn-primary");
canvas.querySelector("#submit-button");
```

## Common Issues

### Issue 1: Element Not Found

```typescript
// âŒ ë¬¸ì œ: ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
const button = canvas.getByRole("button");

// âœ… í•´ê²°: ëŒ€ê¸° í›„ ì°¾ê¸°
await waitFor(async () => {
  const button = await canvas.findByRole("button");
  await expect(button).toBeInTheDocument();
});
```

### Issue 2: Timeout Errors

```typescript
// âŒ ë¬¸ì œ: ê¸°ë³¸ timeout ì´ˆê³¼
await waitFor(() => {
  expect(element).toBeInTheDocument();
});

// âœ… í•´ê²°: timeout ì¦ê°€
await waitFor(
  () => {
    expect(element).toBeInTheDocument();
  },
  { timeout: 5000 },
);
```

### Issue 3: Multiple Elements

```typescript
// âŒ ë¬¸ì œ: ì—¬ëŸ¬ ë²„íŠ¼ì´ ìˆì„ ë•Œ
const button = canvas.getByRole("button");

// âœ… í•´ê²°: êµ¬ì²´ì ì¸ name ì‚¬ìš©
const submitButton = canvas.getByRole("button", { name: /submit/i });
const cancelButton = canvas.getByRole("button", { name: /cancel/i });
```

## Resources

- [Storybook Play Functions](https://storybook.js.org/docs/writing-tests/interaction-testing)
- [Testing Library Queries](https://testing-library.com/docs/queries/about)
- [Vitest Documentation](https://vitest.dev)
- [Playwright Documentation](https://playwright.dev)
- [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)
