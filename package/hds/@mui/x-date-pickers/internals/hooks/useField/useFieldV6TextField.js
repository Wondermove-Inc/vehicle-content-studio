import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as t from"react";import{useRtl as n}from"../../../../system/esm/RtlProvider/index.js";import{getActiveElement as r}from"../../utils/utils.js";import{isAndroid as l,getSectionVisibleValue as o}from"./useField.utils.js";import u from"../../../../utils/useForkRef/useForkRef.js";import s from"../../../../utils/useEventCallback/useEventCallback.js";const c=e=>e.replace(/[\u2066\u2067\u2068\u2069]/g,""),a=(t,n,r)=>{let l=0,u=r?1:0;const s=[];for(let a=0;a<t.length;a+=1){const i=t[a],d=o(i,r?"input-rtl":"input-ltr",n),p=`${i.startSeparator}${d}${i.endSeparator}`,m=c(p).length,f=p.length,g=c(d),S=u+(""===g?0:d.indexOf(g[0]))+i.startSeparator.length,h=S+g.length;s.push(e({},i,{start:l,end:l+m,startInInput:S,endInInput:h})),l+=m,u+=f}return s},i=e=>{const o=n(),i=t.useRef(),{forwardedProps:{onFocus:d,onClick:p,onPaste:m,onBlur:f,inputRef:g,placeholder:S},internalProps:{readOnly:h=!1},parsedSelectedSections:I,activeSectionIndex:v,state:y,fieldValueManager:V,valueManager:F,applyCharacterEditing:x,resetCharacterQuery:T,updateSectionValue:M,updateValueFromValueStr:b,clearActiveSection:A,clearValue:E,setTempAndroidValueStr:C,setSelectedSections:D,getSectionsFromValue:R,areAllSectionsEmpty:k,localizedDigits:O}=e,P=t.useRef(null),j=u(g,P),$=t.useMemo((()=>a(y.sections,O,o)),[y.sections,O,o]),z=t.useMemo((()=>({syncSelectionToDOM:()=>{if(!P.current)return;if(null==I)return void(P.current.scrollLeft&&(P.current.scrollLeft=0));if(P.current!==r(document))return;const e=P.current.scrollTop;if("all"===I)P.current.select();else{const e=$[I],t="empty"===e.type?e.startInInput-e.startSeparator.length:e.startInInput,n="empty"===e.type?e.endInInput+e.endSeparator.length:e.endInInput;t===P.current.selectionStart&&n===P.current.selectionEnd||P.current===r(document)&&P.current.setSelectionRange(t,n)}P.current.scrollTop=e},getActiveSectionIndexFromDOM:()=>{const e=P.current.selectionStart??0,t=P.current.selectionEnd??0,n=!!P.current?.readOnly;if(0===e&&0===t||n)return null;const r=e<=$[0].startInInput?1:$.findIndex((t=>t.startInInput-t.startSeparator.length>e));return-1===r?$.length-1:r-1},focusField:(e=0)=>{P.current?.focus(),D(e)},setSelectedSections:e=>D(e),isFieldFocused:()=>P.current===r(document)})),[P,I,$,D]),w=()=>{if(h)return void D(null);const e=P.current.selectionStart??0;let t;t=e<=$[0].startInInput||e>=$[$.length-1].endInInput?1:$.findIndex((t=>t.startInInput-t.startSeparator.length>e));const n=-1===t?$.length-1:t-1;D(n)},N=s(((...e)=>{d?.(...e);const t=P.current;clearTimeout(i.current),i.current=setTimeout((()=>{t&&t===P.current&&(null!=v||h||(t.value.length&&Number(t.selectionEnd)-Number(t.selectionStart)===t.value.length?D("all"):w()))}))})),Z=s(((e,...t)=>{e.isDefaultPrevented()||(p?.(e,...t),w())})),B=s((e=>{if(m?.(e),e.preventDefault(),h)return;const t=e.clipboardData.getData("text");if("number"==typeof I){const e=y.sections[I],n=/^[a-zA-Z]+$/.test(t),r=/^[0-9]+$/.test(t),l=/^(([a-zA-Z]+)|)([0-9]+)(([a-zA-Z]+)|)$/.test(t);if("letter"===e.contentType&&n||"digit"===e.contentType&&r||"digit-with-letter"===e.contentType&&l)return T(),void M({activeSection:e,newSectionValue:t,shouldGoToNextSection:!0});if(n||r)return}T(),b(t)})),L=s(((...e)=>{f?.(...e),D(null)})),G=s((e=>{if(h)return;const t=e.target.value;if(""===t)return T(),void E();const n=e.nativeEvent.data,r=n&&n.length>1,u=r?n:t,s=c(u);if(null==v||r)return void b(r?n:s);let a;if("all"===I&&1===s.length)a=s;else{const e=c(V.getV6InputValueFromSections($,O,o));let t=-1,n=-1;for(let r=0;r<e.length;r+=1)-1===t&&e[r]!==s[r]&&(t=r),-1===n&&e[e.length-r-1]!==s[s.length-r-1]&&(n=r);const r=$[v];if(t<r.start||e.length-n-1>r.end)return;const l=s.length-e.length+r.end-c(r.endSeparator||"").length;a=s.slice(r.start+c(r.startSeparator||"").length,l)}0!==a.length?x({keyPressed:a,sectionIndex:v}):l()?C(u):(T(),A())})),Q=t.useMemo((()=>void 0!==S?S:V.getV6InputValueFromSections(R(F.emptyValue),O,o)),[S,V,R,F.emptyValue,O,o]),q=t.useMemo((()=>y.tempValueStrAndroid??V.getV6InputValueFromSections(y.sections,O,o)),[y.sections,V,y.tempValueStrAndroid,O,o]);t.useEffect((()=>(P.current&&P.current===r(document)&&D("all"),()=>{clearTimeout(i.current)})),[]);const H=t.useMemo((()=>null==v||"letter"===y.sections[v].contentType?"text":"numeric"),[v,y.sections]),J=P.current&&P.current===r(document);return{interactions:z,returnedValue:{readOnly:h,onBlur:L,onClick:Z,onFocus:N,onPaste:B,inputRef:j,enableAccessibleFieldDOMStructure:!1,placeholder:Q,inputMode:H,autoComplete:"off",value:!J&&k?"":q,onChange:G}}};export{a as addPositionPropertiesToSections,i as useFieldV6TextField};
