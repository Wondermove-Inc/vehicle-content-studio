import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as t from"react";import{useRtl as l}from"../../../../system/esm/RtlProvider/index.js";import{useUtils as a,useLocaleText as n,useLocalizationContext as s}from"../useUtils.js";import{getLocalizedDigits as r,getSectionsBoundaries as o,validateSections as i,parseSelectedSections as u,getDateFromDateSections as c,mergeDateIntoReferenceDate as d}from"./useField.utils.js";import{buildSectionsFromFormat as m}from"./buildSectionsFromFormat.js";import{useValueWithTimezone as f}from"../useValueWithTimezone.js";import{getSectionTypeGranularity as V}from"../../utils/getDefaultReferenceDate.js";import p from"../../../../utils/useControlled/useControlled.js";const v=v=>{const g=a(),S=n(),D=s(),z=l(),{valueManager:A,fieldValueManager:h,valueType:F,validator:M,internalProps:b,internalProps:{value:R,defaultValue:y,referenceDate:j,onChange:T,format:w,formatDensity:x="dense",selectedSections:C,onSelectedSectionsChange:N,shouldRespectLeadingZeros:E=!1,timezone:I,enableAccessibleFieldDOMStructure:L=!1}}=v,{timezone:O,value:P,handleValueChange:Z}=f({timezone:I,value:R,defaultValue:y,onChange:T,valueManager:A}),q=t.useMemo((()=>r(g)),[g]),k=t.useMemo((()=>o(g,q,O)),[g,q,O]),B=t.useCallback(((e,t=null)=>h.getSectionsFromValue(g,e,t,(e=>m({utils:g,timezone:O,localeText:S,localizedDigits:q,format:w,date:e,formatDensity:x,shouldRespectLeadingZeros:E,enableAccessibleFieldDOMStructure:L,isRtl:z})))),[h,w,S,q,z,E,g,x,O,L]),[G,U]=t.useState((()=>{const t=B(P);i(t,F);const l={sections:t,value:P,referenceValue:A.emptyValue,tempValueStrAndroid:null},a=V(t),n=A.getInitialReferenceValue({referenceDate:j,value:P,utils:g,props:b,granularity:a,timezone:O});return e({},l,{referenceValue:n})})),[W,H]=p({controlled:C,default:null,name:"useField",state:"selectedSections"}),J=e=>{H(e),N?.(e)},K=t.useMemo((()=>u(W,G.sections)),[W,G.sections]),Q="all"===K?0:K,X=({value:t,referenceValue:l,sections:a})=>{if(U((n=>e({},n,{sections:a,value:t,referenceValue:l,tempValueStrAndroid:null}))),A.areValuesEqual(g,G.value,t))return;const n={validationError:M({adapter:D,value:t,props:e({},b,{value:t,timezone:O})})};Z(t,n)},Y=(t,l)=>{const a=[...G.sections];return a[t]=e({},a[t],{value:l,modified:!0}),a};return t.useEffect((()=>{const t=B(G.value);i(t,F),U((l=>e({},l,{sections:t})))}),[w,g.locale,z]),t.useEffect((()=>{let t;t=!A.areValuesEqual(g,G.value,P)||A.getTimezone(g,G.value)!==A.getTimezone(g,P),t&&U((t=>e({},t,{value:P,referenceValue:h.updateReferenceValue(g,P,t.referenceValue),sections:B(P)})))}),[P]),{state:G,activeSectionIndex:Q,parsedSelectedSections:K,setSelectedSections:J,clearValue:()=>{X({value:A.emptyValue,referenceValue:G.referenceValue,sections:B(A.emptyValue)})},clearActiveSection:()=>{if(null==Q)return;const t=G.sections[Q],l=h.getActiveDateManager(g,G,t),a=l.getSections(G.sections).filter((e=>""!==e.value)).length===(""===t.value?0:1),n=Y(Q,""),s=a?null:g.getInvalidDate(),r=l.getNewValuesFromNewActiveDate(s);X(e({},r,{sections:n}))},updateSectionValue:({activeSection:t,newSectionValue:l,shouldGoToNextSection:a})=>{a&&Q<G.sections.length-1&&J(Q+1);const n=h.getActiveDateManager(g,G,t),s=Y(Q,l),r=n.getSections(s),o=c(g,r,q);let i,u;if(null!=o&&g.isValid(o)){const e=d(g,O,o,r,n.referenceDate,!0);i=n.getNewValuesFromNewActiveDate(e),u=!0}else i=n.getNewValuesFromNewActiveDate(o),u=(null!=o&&!g.isValid(o))!=(null!=n.date&&!g.isValid(n.date));return u?X(e({},i,{sections:s})):U((t=>e({},t,i,{sections:s,tempValueStrAndroid:null})))},updateValueFromValueStr:e=>{const t=h.parseValueStr(e,G.referenceValue,((e,t)=>{const l=g.parse(e,w);if(null==l||!g.isValid(l))return null;const a=m({utils:g,timezone:O,localeText:S,localizedDigits:q,format:w,date:l,formatDensity:x,shouldRespectLeadingZeros:E,enableAccessibleFieldDOMStructure:L,isRtl:z});return d(g,O,l,a,t,!1)})),l=h.updateReferenceValue(g,t,G.referenceValue);X({value:t,referenceValue:l,sections:B(t,G.sections)})},setTempAndroidValueStr:t=>U((l=>e({},l,{tempValueStrAndroid:t}))),getSectionsFromValue:B,sectionsValueBoundaries:k,localizedDigits:q,timezone:O}};export{v as useFieldState};
