import*as e from"react";import{parseSelectedSections as t,getSectionValueNow as n,getSectionValueText as r}from"./useField.utils.js";import{getActiveElement as o}from"../../utils/utils.js";import{useLocaleText as i,useUtils as s}from"../useUtils.js";import a from"../../../../utils/useForkRef/useForkRef.js";import c from"../../../../utils/useId/useId.js";import u from"../../../../utils/useEventCallback/useEventCallback.js";import l from"../../../../utils/useEnhancedEffect/useEnhancedEffect.js";const d=d=>{const{internalProps:{disabled:f,readOnly:p=!1},forwardedProps:{sectionListRef:m,onBlur:g,onClick:v,onFocus:S,onInput:y,onPaste:h,focused:x,autoFocus:b=!1},fieldValueManager:C,applyCharacterEditing:D,resetCharacterQuery:I,setSelectedSections:M,parsedSelectedSections:F,state:R,clearActiveSection:T,clearValue:k,updateSectionValue:E,updateValueFromValueStr:O,sectionOrder:A,areAllSectionsEmpty:P,sectionsValueBoundaries:$}=d,w=e.useRef(null),L=a(m,w),V=i(),j=s(),z=c(),[H,B]=e.useState(!1),U=e.useMemo((()=>({syncSelectionToDOM:()=>{if(!w.current)return;const e=document.getSelection();if(!e)return;if(null==F)return e.rangeCount>0&&w.current.getRoot().contains(e.getRangeAt(0).startContainer)&&e.removeAllRanges(),void(H&&w.current.getRoot().blur());if(!w.current.getRoot().contains(o(document)))return;const t=new window.Range;let n;if("all"===F)n=w.current.getRoot();else{n="empty"===R.sections[F].type?w.current.getSectionContainer(F):w.current.getSectionContent(F)}t.selectNodeContents(n),n.focus(),e.removeAllRanges(),e.addRange(t)},getActiveSectionIndexFromDOM:()=>{const e=o(document);return e&&w.current&&w.current.getRoot().contains(e)?w.current.getSectionIndexFromDOMElement(e):null},focusField:(e=0)=>{if(!w.current)return;const n=t(e,R.sections);B(!0),w.current.getSectionContent(n).focus()},setSelectedSections:e=>{if(!w.current)return;const n=t(e,R.sections);B(null!==("all"===n?0:n)),M(e)},isFieldFocused:()=>{const e=o(document);return!!w.current&&w.current.getRoot().contains(e)}})),[F,M,R.sections,H]),Z=u((e=>{if(!w.current)return;const t=R.sections[e];w.current.getSectionContent(e).innerHTML=t.value||t.placeholder,U.syncSelectionToDOM()})),N=u(((e,...t)=>{if(!e.isDefaultPrevented()&&w.current)if(B(!0),v?.(e,...t),"all"===F)setTimeout((()=>{const e=document.getSelection().getRangeAt(0).startOffset;if(0===e)return void M(A.startIndex);let t=0,n=0;for(;n<e&&t<R.sections.length;){const e=R.sections[t];t+=1,n+=`${e.startSeparator}${e.value||e.placeholder}${e.endSeparator}`.length}M(t-1)}));else if(H){w.current.getRoot().contains(e.target)||M(A.startIndex)}else B(!0),M(A.startIndex)})),G=u((e=>{if(y?.(e),!w.current||"all"!==F)return;const t=e.target.textContent??"";w.current.getRoot().innerHTML=R.sections.map((e=>`${e.startSeparator}${e.value||e.placeholder}${e.endSeparator}`)).join(""),U.syncSelectionToDOM(),0===t.length||10===t.charCodeAt(0)?(I(),k(),M("all")):t.length>1?O(t):D({keyPressed:t,sectionIndex:0})})),K=u((e=>{if(h?.(e),p||"all"!==F)return void e.preventDefault();const t=e.clipboardData.getData("text");e.preventDefault(),I(),O(t)})),Q=u(((...e)=>{if(S?.(...e),H||!w.current)return;B(!0);null!=w.current.getSectionIndexFromDOMElement(o(document))||M(A.startIndex)})),X=u(((...e)=>{g?.(...e),setTimeout((()=>{if(!w.current)return;const e=o(document);!w.current.getRoot().contains(e)&&(B(!1),M(null))}))})),Y=u((e=>t=>{t.isDefaultPrevented()||p||M(e)})),q=u((e=>{e.preventDefault()})),J=u((e=>()=>{p||M(e)})),W=u((e=>{if(e.preventDefault(),p||"number"!=typeof F)return;const t=R.sections[F],n=e.clipboardData.getData("text"),r=/^[a-zA-Z]+$/.test(n),o=/^[0-9]+$/.test(n),i=/^(([a-zA-Z]+)|)([0-9]+)(([a-zA-Z]+)|)$/.test(n);"letter"===t.contentType&&r||"digit"===t.contentType&&o||"digit-with-letter"===t.contentType&&i?(I(),E({activeSection:t,newSectionValue:n,shouldGoToNextSection:!0})):r||o||(I(),O(n))})),_=u((e=>{e.preventDefault(),e.dataTransfer.dropEffect="none"})),ee=u((e=>{if(!w.current)return;const t=e.target,n=t.textContent??"",r=w.current.getSectionIndexFromDOMElement(t),o=R.sections[r];if(!p&&w.current){if(0===n.length){if(""===o.value)return void Z(r);const t=e.nativeEvent.inputType;return"insertParagraph"===t||"insertLineBreak"===t?void Z(r):(I(),void T())}D({keyPressed:n,sectionIndex:r}),Z(r)}else Z(r)}));l((()=>{if(H&&w.current)if("all"===F)w.current.getRoot().focus();else if("number"==typeof F){const e=w.current.getSectionContent(F);e&&e.focus()}}),[F,H]);const te=e.useMemo((()=>R.sections.reduce(((e,t)=>(e[t.type]=$[t.type]({currentDate:null,contentType:t.contentType,format:t.format}),e)),{})),[$,R.sections]),ne="all"===F,re=e.useMemo((()=>R.sections.map(((t,o)=>{const i=!ne&&!f&&!p;return{container:{"data-sectionindex":o,onClick:Y(o)},content:{tabIndex:ne||o>0?-1:0,contentEditable:!ne&&!f&&!p,role:"spinbutton",id:`${z}-${t.type}`,"aria-labelledby":`${z}-${t.type}`,"aria-readonly":p,"aria-valuenow":n(t,j),"aria-valuemin":te[t.type].minimum,"aria-valuemax":te[t.type].maximum,"aria-valuetext":t.value?r(t,j):V.empty,"aria-label":V[t.type],"aria-disabled":f,spellCheck:!i&&void 0,autoCapitalize:i?"off":void 0,autoCorrect:i?"off":void 0,[parseInt(e.version,10)>=17?"enterKeyHint":"enterkeyhint"]:i?"next":void 0,children:t.value||t.placeholder,onInput:ee,onPaste:W,onFocus:J(o),onDragOver:_,onMouseUp:q,inputMode:"letter"===t.contentType?"text":"numeric"},before:{children:t.startSeparator},after:{children:t.endSeparator}}}))),[R.sections,J,W,_,ee,Y,q,f,p,ne,V,j,te,z]),oe=u((e=>{O(e.target.value)})),ie=e.useMemo((()=>P?"":C.getV7HiddenInputValueFromSections(R.sections)),[P,R.sections,C]);return e.useEffect((()=>{if(null==w.current)throw new Error(["MUI X: The `sectionListRef` prop has not been initialized by `PickersSectionList`","You probably tried to pass a component to the `textField` slot that contains an `<input />` element instead of a `PickersSectionList`.","","If you want to keep using an `<input />` HTML element for the editing, please remove the `enableAccessibleFieldDOMStructure` prop from your picker or field component:","","<DatePicker slots={{ textField: MyCustomTextField }} />","","Learn more about the field accessible DOM structure on the MUI documentation: https://mui.com/x/react-date-pickers/fields/#fields-to-edit-a-single-element"].join("\n"));b&&w.current&&w.current.getSectionContent(A.startIndex).focus()}),[]),{interactions:U,returnedValue:{autoFocus:b,readOnly:p,focused:x??H,sectionListRef:L,onBlur:X,onClick:N,onFocus:Q,onInput:G,onPaste:K,enableAccessibleFieldDOMStructure:!0,elements:re,tabIndex:0===F?-1:0,contentEditable:ne,value:ie,onChange:oe,areAllSectionsEmpty:P}}};export{d as useFieldV7TextField};
