import t from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as e from"react";import{useGridApiOptionHandler as i,useGridApiEventHandler as r}from"../../utils/useGridApiEventHandler.js";import{useGridApiMethod as o}from"../../utils/useGridApiMethod.js";import{throttle as n}from"../../../utils/throttle.js";import{useGridLogger as h}from"../../utils/useGridLogger.js";import{gridDimensionsSelector as s}from"./gridDimensionsSelectors.js";import{getVisibleRows as a}from"../../utils/useGridVisibleRows.js";import{gridRowsMetaSelector as d}from"../rows/gridRowsMetaSelector.js";import{calculatePinnedRowsHeight as l}from"../rows/gridRowsUtils.js";import{getTotalHeaderHeight as u}from"../columns/gridColumnsUtils.js";import{useGridSelector as c}from"../../utils/useGridSelector.js";import{gridVisiblePinnedColumnDefinitionsSelector as m,gridColumnsTotalWidthSelector as g}from"../columns/gridColumnsSelector.js";import p from"../../../../utils/useEventCallback/useEventCallback.js";import w from"../../../../utils/ownerWindow/ownerWindow.js";import f from"../../../../utils/useEnhancedEffect/useEnhancedEffect.js";import S from"../../../../utils/ownerDocument/ownerDocument.js";import{gridDensityFactorSelector as H}from"../density/densitySelector.js";import{gridRenderContextSelector as z}from"../virtualization/gridVirtualizationSelectors.js";const b={width:0,height:0},x={isReady:!1,root:b,viewportOuterSize:b,viewportInnerSize:b,contentSize:b,minimumSize:b,hasScrollX:!1,hasScrollY:!1,scrollbarSize:0,headerHeight:0,headerFilterHeight:0,rowWidth:0,rowHeight:0,columnsTotalWidth:0,leftPinnedWidth:0,rightPinnedWidth:0,headersTotalHeight:0,topContainerHeight:0,bottomContainerHeight:0},M=e=>t({},e,{dimensions:x});function v(x,M){const v=h(x,"useResizeContainer"),R=e.useRef(!1),W=e.useRef(b),j=c(x,d),D=c(x,m),G=c(x,H),y=Math.floor(M.rowHeight*G),T=Math.floor(M.columnHeaderHeight*G),E=Math.floor((M.headerFilterHeight??M.columnHeaderHeight)*G),P=($=g(x),I=6,Math.round($*10**I)/10**I);var $,I;const k=u(x,M),F=D.left.reduce(((t,e)=>t+e.computedWidth),0),O=D.right.reduce(((t,e)=>t+e.computedWidth),0),[X,Y]=e.useState(),A=e.useMemo((()=>n(Y,M.resizeThrottleMs)),[M.resizeThrottleMs]),N=e.useRef(),V=p((e=>{x.current.setState((i=>t({},i,{dimensions:e})))})),U=e.useCallback((()=>{const t=x.current.mainElementRef.current;if(!t)return;const e=w(t).getComputedStyle(t),i={width:parseFloat(e.width)||0,height:parseFloat(e.height)||0};N.current&&C(N.current,i)||(x.current.publishEvent("resize",i),N.current=i)}),[x]),L=e.useCallback((()=>{const t=s(x.current.state);if(!t.isReady)return 0;const e=a(x,{pagination:M.pagination,paginationMode:M.paginationMode});if(M.getRowHeight){const t=z(x),i=t.lastRowIndex-t.firstRowIndex;return Math.min(i-1,e.rows.length)}const i=Math.floor(t.viewportInnerSize.height/y);return Math.min(i,e.rows.length)}),[x,M.pagination,M.paginationMode,M.getRowHeight,y]),q=e.useCallback((()=>{const t=x.current.rootElementRef.current,e=l(x),i=function(t,e,i){if(void 0!==i)return i;if(null===t||0===e)return 0;const r=S(t),o=r.createElement("div");o.style.width="99px",o.style.height="99px",o.style.position="absolute",o.style.overflow="scroll",o.className="scrollDiv",t.appendChild(o);const n=o.offsetWidth-o.clientWidth;return t.removeChild(o),n}(t,P,M.scrollbarSize),r=k+e.top,o=e.bottom,n={width:P-F-O,height:j.currentPageTotalHeight};let h,s,a=!1,d=!1;if(M.autoHeight)d=!1,a=Math.round(P)>Math.round(W.current.width),h={width:W.current.width,height:r+o+n.height},s={width:Math.max(0,h.width-(d?i:0)),height:Math.max(0,h.height-(a?i:0))};else{h={width:W.current.width,height:W.current.height},s={width:Math.max(0,h.width-F-O),height:Math.max(0,h.height-r-o)};const t=n,e=s,l=t.width>e.width,u=t.height>e.height;(l||u)&&(d=u,a=t.width+(d?i:0)>e.width,a&&(d=t.height+i>e.height)),d&&(s.width-=i),a&&(s.height-=i)}const u=Math.max(h.width,P+(d?i:0)),c={width:P,height:r+n.height+o},m={isReady:!0,root:W.current,viewportOuterSize:h,viewportInnerSize:s,contentSize:n,minimumSize:c,hasScrollX:a,hasScrollY:d,scrollbarSize:i,headerHeight:T,headerFilterHeight:E,rowWidth:u,rowHeight:y,columnsTotalWidth:P,leftPinnedWidth:F,rightPinnedWidth:O,headersTotalHeight:k,topContainerHeight:r,bottomContainerHeight:o},g=x.current.state.dimensions;V(m),C(m.viewportInnerSize,g.viewportInnerSize)||x.current.publishEvent("viewportInnerSizeChange",m.viewportInnerSize),x.current.updateRenderContext?.()}),[x,V,M.scrollbarSize,M.autoHeight,j.currentPageTotalHeight,y,T,E,P,k,F,O]),B={updateDimensions:q,getViewportPageSize:L};o(x,{resize:U,getRootDimensions:()=>x.current.state.dimensions},"public"),o(x,B,"private"),f((()=>{X&&(q(),x.current.publishEvent("debouncedResize",W.current))}),[x,X,q]);const J=x.current.rootElementRef.current,K=x.current.state.dimensions;f((()=>{if(!J)return;const t=(t,e)=>J.style.setProperty(t,e);t("--DataGrid-width",`${K.viewportOuterSize.width}px`),t("--DataGrid-hasScrollX",`${Number(K.hasScrollX)}`),t("--DataGrid-hasScrollY",`${Number(K.hasScrollY)}`),t("--DataGrid-scrollbarSize",`${K.scrollbarSize}px`),t("--DataGrid-rowWidth",`${K.rowWidth}px`),t("--DataGrid-columnsTotalWidth",`${K.columnsTotalWidth}px`),t("--DataGrid-leftPinnedWidth",`${K.leftPinnedWidth}px`),t("--DataGrid-rightPinnedWidth",`${K.rightPinnedWidth}px`),t("--DataGrid-headerHeight",`${K.headerHeight}px`),t("--DataGrid-headersTotalHeight",`${K.headersTotalHeight}px`),t("--DataGrid-topContainerHeight",`${K.topContainerHeight}px`),t("--DataGrid-bottomContainerHeight",`${K.bottomContainerHeight}px`),t("--height",`${K.rowHeight}px`)}),[J,K]);const Q=e.useRef(!0),Z=e.useCallback((t=>{W.current=t;const e=/jsdom/.test(window.navigator.userAgent);if(0!==t.height||R.current||M.autoHeight||e||(v.error(["The parent DOM element of the data grid has an empty height.","Please make sure that this element has an intrinsic height.","The grid displays with a height of 0px.","","More details: https://mui.com/r/x-data-grid-no-dimensions."].join("\n")),R.current=!0),0!==t.width||R.current||e||(v.error(["The parent DOM element of the data grid has an empty width.","Please make sure that this element has an intrinsic width.","The grid displays with a width of 0px.","","More details: https://mui.com/r/x-data-grid-no-dimensions."].join("\n")),R.current=!0),Q.current)return Y(t),void(Q.current=!1);A(t)}),[M.autoHeight,A,v]);f(q,[q]),i(x,"sortedRowsSet",q),i(x,"paginationModelChange",q),i(x,"columnsChange",q),r(x,"resize",Z),i(x,"debouncedResize",M.onResize)}function C(t,e){return t.width===e.width&&t.height===e.height}export{M as dimensionsStateInitializer,v as useGridDimensions};
