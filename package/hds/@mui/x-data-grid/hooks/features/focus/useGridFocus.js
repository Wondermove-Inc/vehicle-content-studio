import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as l from"react";import{gridClasses as r}from"../../../constants/gridClasses.js";import{useGridApiMethod as u}from"../../utils/useGridApiMethod.js";import{useGridLogger as n}from"../../utils/useGridLogger.js";import{useGridApiEventHandler as t}from"../../utils/useGridApiEventHandler.js";import{isNavigationKey as o}from"../../../utils/keyboardUtils.js";import{gridFocusCellSelector as c,gridFocusColumnGroupHeaderSelector as a}from"./gridFocusStateSelector.js";import{gridVisibleColumnDefinitionsSelector as i}from"../columns/gridColumnsSelector.js";import{getVisibleRows as s}from"../../utils/useGridVisibleRows.js";import{clamp as d}from"../../../utils/utils.js";import{gridPinnedRowsSelector as m}from"../rows/gridRowsSelector.js";import f from"../../../../utils/useEventCallback/useEventCallback.js";import p from"../../../../utils/ownerDocument/ownerDocument.js";const H=l=>e({},l,{focus:{cell:null,columnHeader:null,columnHeaderFilter:null,columnGroupHeader:null},tabIndex:{cell:null,columnHeader:null,columnHeaderFilter:null,columnGroupHeader:null}}),g=(H,g)=>{const C=n(H,"useGridFocus"),b=l.useRef(null),F=l.useCallback(((e,l)=>{e&&H.current.getRow(e.id)&&H.current.publishEvent("cellFocusOut",H.current.getCellParams(e.id,e.field),l)}),[H]),h=l.useCallback(((l,r)=>{const u=c(H);u?.id===l&&u?.field===r||(H.current.setState((u=>(C.debug(`Focusing on cell with id=${l} and field=${r}`),e({},u,{tabIndex:{cell:{id:l,field:r},columnHeader:null,columnHeaderFilter:null,columnGroupHeader:null},focus:{cell:{id:l,field:r},columnHeader:null,columnHeaderFilter:null,columnGroupHeader:null}})))),H.current.forceUpdate(),H.current.getRow(l)&&(u&&F(u,{}),H.current.publishEvent("cellFocusIn",H.current.getCellParams(l,r))))}),[H,C,F]),k=l.useCallback(((l,r={})=>{const u=c(H);F(u,r),H.current.setState((r=>(C.debug(`Focusing on column header with colIndex=${l}`),e({},r,{tabIndex:{columnHeader:{field:l},columnHeaderFilter:null,cell:null,columnGroupHeader:null},focus:{columnHeader:{field:l},columnHeaderFilter:null,cell:null,columnGroupHeader:null}})))),H.current.forceUpdate()}),[H,C,F]),G=l.useCallback(((l,r={})=>{const u=c(H);F(u,r),H.current.setState((r=>(C.debug(`Focusing on column header filter with colIndex=${l}`),e({},r,{tabIndex:{columnHeader:null,columnHeaderFilter:{field:l},cell:null,columnGroupHeader:null},focus:{columnHeader:null,columnHeaderFilter:{field:l},cell:null,columnGroupHeader:null}})))),H.current.forceUpdate()}),[H,C,F]),w=l.useCallback(((l,r,u={})=>{const n=c(H);n&&H.current.publishEvent("cellFocusOut",H.current.getCellParams(n.id,n.field),u),H.current.setState((u=>e({},u,{tabIndex:{columnGroupHeader:{field:l,depth:r},columnHeader:null,columnHeaderFilter:null,cell:null},focus:{columnGroupHeader:{field:l,depth:r},columnHeader:null,columnHeaderFilter:null,cell:null}}))),H.current.forceUpdate()}),[H]),S=l.useCallback((()=>a(H)),[H]),v=l.useCallback(((e,l,r)=>{let u=H.current.getColumnIndex(l);const n=i(H),t=s(H,{pagination:g.pagination,paginationMode:g.paginationMode}),o=m(H),c=[].concat(o.top||[],t.rows,o.bottom||[]);let a=c.findIndex((l=>l.id===e));"right"===r?u+=1:"left"===r?u-=1:a+=1,u>=n.length?(a+=1,a<c.length&&(u=0)):u<0&&(a-=1,a>=0&&(u=n.length-1)),a=d(a,0,c.length-1);const f=c[a];if(!f)return;const p=H.current.unstable_getCellColSpanInfo(f.id,u);p&&p.spannedByColSpan&&("left"===r||"below"===r?u=p.leftVisibleCellIndex:"right"===r&&(u=p.rightVisibleCellIndex)),u=d(u,0,n.length-1);const C=n[u];H.current.setCellFocus(f.id,C.field)}),[H,g.pagination,g.paginationMode]),x=l.useCallback((({id:e,field:l})=>{H.current.setCellFocus(e,l)}),[H]),I=l.useCallback(((e,l)=>{"Enter"===l.key||"Tab"===l.key||"Shift"===l.key||o(l.key)||H.current.setCellFocus(e.id,e.field)}),[H]),j=l.useCallback((({field:e},l)=>{l.target===l.currentTarget&&H.current.setColumnHeaderFocus(e,l)}),[H]),E=l.useCallback((({fields:e,depth:l},r)=>{if(r.target!==r.currentTarget)return;const u=a(H);null!==u&&u.depth===l&&e.includes(u.field)||H.current.setColumnGroupHeaderFocus(e[0],l,r)}),[H]),M=l.useCallback(((l,u)=>{u.relatedTarget?.getAttribute("class")?.includes(r.columnHeader)||(C.debug("Clearing focus"),H.current.setState((l=>e({},l,{focus:{cell:null,columnHeader:null,columnHeaderFilter:null,columnGroupHeader:null}}))))}),[C,H]),y=l.useCallback((e=>{b.current=e}),[]),R=l.useCallback((l=>{const r=b.current;b.current=null;const u=c(H);if(!H.current.unstable_applyPipeProcessors("canUpdateFocus",!0,{event:l,cell:r}))return;if(!u)return void(r&&H.current.setCellFocus(r.id,r.field));if(r?.id===u.id&&r?.field===u.field)return;const n=H.current.getCellElement(u.id,u.field);n?.contains(l.target)||(r?H.current.setCellFocus(r.id,r.field):(H.current.setState((l=>e({},l,{focus:{cell:null,columnHeader:null,columnHeaderFilter:null,columnGroupHeader:null}}))),H.current.forceUpdate(),F(u,l)))}),[H,F]),U=l.useCallback((e=>{if("view"===e.cellMode)return;const l=c(H);l?.id===e.id&&l?.field===e.field||H.current.setCellFocus(e.id,e.field)}),[H]),D=l.useCallback((()=>{const l=c(H);l&&!H.current.getRow(l.id)&&H.current.setState((l=>e({},l,{focus:{cell:null,columnHeader:null,columnHeaderFilter:null,columnGroupHeader:null}})))}),[H]),P=f((()=>{const l=c(H);if(!l)return;const r=s(H,{pagination:g.pagination,paginationMode:g.paginationMode});if(r.rows.find((e=>e.id===l.id)))return;const u=i(H);H.current.setState((l=>e({},l,{tabIndex:{cell:{id:r.rows[0].id,field:u[0].field},columnGroupHeader:null,columnHeader:null,columnHeaderFilter:null}})))})),T={moveFocusToRelativeCell:v,setColumnGroupHeaderFocus:w,getColumnGroupHeaderFocus:S};u(H,{setCellFocus:h,setColumnHeaderFocus:k,setColumnHeaderFilterFocus:G},"public"),u(H,T,"private"),l.useEffect((()=>{const e=p(H.current.rootElementRef.current);return e.addEventListener("mouseup",R),()=>{e.removeEventListener("mouseup",R)}}),[H,R]),t(H,"columnHeaderBlur",M),t(H,"cellDoubleClick",x),t(H,"cellMouseDown",y),t(H,"cellKeyDown",I),t(H,"cellModeChange",U),t(H,"columnHeaderFocus",j),t(H,"columnGroupHeaderFocus",E),t(H,"rowsSet",D),t(H,"paginationModelChange",P)};export{H as focusStateInitializer,g as useGridFocus};
