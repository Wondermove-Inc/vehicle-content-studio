import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as t from"react";import{useGridLogger as o}from"../../utils/useGridLogger.js";import{gridExpandedRowCountSelector as r}from"../filter/gridFilterSelector.js";import{gridColumnDefinitionsSelector as n,gridColumnVisibilityModelSelector as i}from"../columns/gridColumnsSelector.js";import{gridClasses as s}from"../../../constants/gridClasses.js";import{useGridApiMethod as l}from"../../utils/useGridApiMethod.js";import{gridRowsMetaSelector as a}from"../rows/gridRowsMetaSelector.js";import{GRID_ID_AUTOGENERATED as c}from"../rows/gridRowsUtils.js";import{getColumnsToExport as u,defaultGetRowsToExport as d}from"./utils.js";import{getDerivedPaginationModel as p}from"../pagination/useGridPaginationModel.js";import{GridPrintExportMenuItem as m}from"../../../components/toolbar/GridToolbarExport.js";import{getTotalHeaderHeight as f}from"../columns/gridColumnsUtils.js";import{GRID_CHECKBOX_SELECTION_COL_DEF as g}from"../../../colDef/gridCheckboxSelectionColDef.js";import{jsx as h}from"react/jsx-runtime";import b from"../../../../utils/ownerDocument/ownerDocument.js";import{useGridRegisterPipeProcessor as y}from"../../core/pipeProcessing/useGridRegisterPipeProcessor.js";const C=(C,S)=>{const x=o(C,"useGridPrintExport"),w=t.useRef(null),E=t.useRef(null),R=t.useRef({}),N=t.useRef([]),j=t.useRef();t.useEffect((()=>{w.current=b(C.current.rootElementRef.current)}),[C]);const v=t.useCallback(((e,t,o)=>new Promise((r=>{const i=u({apiRef:C,options:{fields:e,allColumns:t}}).map((e=>e.field)),s=n(C),l={};s.forEach((e=>{l[e.field]=i.includes(e.field)})),o&&(l[g.field]=!0),C.current.setColumnVisibilityModel(l),r()}))),[C]),T=t.useCallback((e=>{const t=e({apiRef:C}).reduce(((e,t)=>{const o=C.current.getRow(t);return o[c]||e.push(o),e}),[]);C.current.setRows(t)}),[C]),P=t.useCallback(((t,o)=>{const r=e({copyStyles:!0,hideToolbar:!1,hideFooter:!1,includeCheckboxes:!1},o),n=t.contentDocument;if(!n)return;const i=a(C.current.state),l=C.current.rootElementRef.current,c=l.cloneNode(!0);c.querySelector(`.${s.main}`).style.overflow="visible",c.style.contain="size";let u=l.querySelector(`.${s.toolbarContainer}`)?.offsetHeight||0,d=l.querySelector(`.${s.footerContainer}`)?.offsetHeight||0;r.hideToolbar&&(c.querySelector(`.${s.toolbarContainer}`)?.remove(),u=0),r.hideFooter&&(c.querySelector(`.${s.footerContainer}`)?.remove(),d=0);const p=i.currentPageTotalHeight+f(C,S)+u+d;c.style.height=`${p}px`,c.style.boxSizing="content-box";const m=c.querySelector(`.${s.footerContainer}`);m.style.position="absolute",m.style.width="100%",m.style.top=p-d+"px";const g=document.createElement("div");g.appendChild(c),n.body.style.marginTop="0px",n.body.innerHTML=g.innerHTML;const h="function"==typeof r.pageStyle?r.pageStyle():r.pageStyle;if("string"==typeof h){const e=n.createElement("style");e.appendChild(n.createTextNode(h)),n.head.appendChild(e)}r.bodyClassName&&n.body.classList.add(...r.bodyClassName.split(" "));const b=[];if(r.copyStyles){const e=l.getRootNode(),t=("ShadowRoot"===e.constructor.name?e:w.current).querySelectorAll("style, link[rel='stylesheet']");for(let e=0;e<t.length;e+=1){const o=t[e];if("STYLE"===o.tagName){const e=n.createElement(o.tagName),t=o.sheet;if(t){let o="";for(let e=0;e<t.cssRules.length;e+=1)"string"==typeof t.cssRules[e].cssText&&(o+=`${t.cssRules[e].cssText}\r\n`);e.appendChild(n.createTextNode(o)),n.head.appendChild(e)}}else if(o.getAttribute("href")){const e=n.createElement(o.tagName);for(let t=0;t<o.attributes.length;t+=1){const r=o.attributes[t];r&&e.setAttribute(r.nodeName,r.nodeValue||"")}b.push(new Promise((t=>{e.addEventListener("load",(()=>t()))}))),n.head.appendChild(e)}}}"test"!==process.env.NODE_ENV&&Promise.all(b).then((()=>{t.contentWindow.print()}))}),[C,w,S]),M=t.useCallback((t=>{w.current.body.removeChild(t),C.current.restoreState(E.current||{}),E.current?.columns?.columnVisibilityModel||C.current.setColumnVisibilityModel(R.current),C.current.setState((t=>e({},t,{virtualization:j.current}))),C.current.setRows(N.current),E.current=null,R.current={},N.current=[]}),[C]),k=t.useCallback((async t=>{if(x.debug("Export data as Print"),!C.current.rootElementRef.current)throw new Error("MUI X: No grid root element available.");if(E.current=C.current.exportState(),R.current=i(C),N.current=C.current.getSortedRows().filter((e=>!e[c])),S.pagination){const t={page:0,pageSize:r(C)};C.current.setState((o=>e({},o,{pagination:e({},o.pagination,{paginationModel:p(o.pagination,"DataGridPro",t)})})))}j.current=C.current.state.virtualization,C.current.setState((t=>e({},t,{virtualization:e({},t.virtualization,{enabled:!1,enabledForColumns:!1})}))),await v(t?.fields,t?.allColumns,t?.includeCheckboxes),T(t?.getRowsToExport??d),await new Promise((e=>{requestAnimationFrame((()=>{e()}))}));const o=function(e){const t=document.createElement("iframe");return t.style.position="absolute",t.style.width="0px",t.style.height="0px",t.title=e||document.title,t}(t?.fileName);"test"===process.env.NODE_ENV?(w.current.body.appendChild(o),P(o,t),M(o)):(o.onload=()=>{P(o,t);o.contentWindow.matchMedia("print").addEventListener("change",(e=>{!1===e.matches&&M(o)}))},w.current.body.appendChild(o))}),[S,x,C,P,M,v,T]);l(C,{exportDataAsPrint:k},"public");const D=t.useCallback(((e,t)=>t.printOptions?.disableToolbarButton?e:[...e,{component:h(m,{options:t.printOptions}),componentName:"printExport"}]),[]);y(C,"exportMenu",D)};export{C as useGridPrintExport};
