import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as t from"react";import{GridSignature as o,useGridApiEventHandler as r}from"../../utils/useGridApiEventHandler.js";import{useGridApiMethod as l}from"../../utils/useGridApiMethod.js";import{useGridLogger as i}from"../../utils/useGridLogger.js";import{gridRowsLookupSelector as n}from"../rows/gridRowsSelector.js";import{gridRowSelectionStateSelector as c,selectedGridRowsSelector as s,selectedIdsLookupSelector as u}from"./gridRowSelectionSelector.js";import{gridFocusCellSelector as a}from"../focus/gridFocusStateSelector.js";import{gridExpandedSortedRowIdsSelector as d,gridFilterModelSelector as w}from"../filter/gridFilterSelector.js";import{GridCellModes as f}from"../../../models/gridEditRowModel.js";import{isKeyboardEvent as g,isNavigationKey as S}from"../../../utils/keyboardUtils.js";import{useGridVisibleRows as m}from"../../utils/useGridVisibleRows.js";import{GRID_DETAIL_PANEL_TOGGLE_FIELD as R}from"../../../constants/gridDetailPanelToggleField.js";import{gridClasses as p}from"../../../constants/gridClasses.js";import{isEventTargetInPortal as b}from"../../../utils/domUtils.js";import{isMultipleRowSelectionEnabled as h}from"./utils.js";import{gridPaginatedVisibleSortedGridRowIdsSelector as C}from"../pagination/gridPaginationSelector.js";import{GRID_CHECKBOX_SELECTION_COL_DEF as k}from"../../../colDef/gridCheckboxSelectionColDef.js";import{GRID_ACTIONS_COLUMN_TYPE as y}from"../../../colDef/gridActionsColDef.js";const j=(e,t)=>null==e||Array.isArray(e)?e:t&&t[0]===e?t:[e],M=(t,o)=>e({},t,{rowSelection:o.rowSelection?j(o.rowSelectionModel)??[]:[]}),v=(M,v)=>{const x=i(M,"useGridSelection"),D=e=>(...t)=>{v.rowSelection&&e(...t)},E=t.useMemo((()=>j(v.rowSelectionModel,c(M.current.state))),[M,v.rowSelectionModel]),I=t.useRef(null);M.current.registerControlState({stateId:"rowSelection",propModel:E,propOnChange:v.onRowSelectionModelChange,stateSelector:c,changeEvent:"rowSelectionChange"});const{checkboxSelection:A,disableRowSelectionOnClick:G,isRowSelectable:K}=v,O=h(v),P=m(M,v),V=t.useCallback((e=>{let t=e;const o=I.current??e,r=M.current.isRowSelected(e);if(r){const e=d(M),r=e.findIndex((e=>e===o)),l=e.findIndex((e=>e===t));if(r===l)return;t=r>l?e[l+1]:e[l-1]}I.current=e,M.current.selectRowRange({startId:o,endId:t},!r)}),[M]),$=t.useCallback((t=>{if(v.signature===o.DataGrid&&!O&&Array.isArray(t)&&t.length>1)throw new Error(["MUI X: `rowSelectionModel` can only contain 1 item in DataGrid.","You need to upgrade to DataGridPro or DataGridPremium component to unlock multiple selection."].join("\n"));c(M.current.state)!==t&&(x.debug("Setting selection model"),M.current.setState((o=>e({},o,{rowSelection:v.rowSelection?t:[]}))),M.current.forceUpdate())}),[M,x,v.rowSelection,v.signature,O]),N=t.useCallback((e=>c(M.current.state).includes(e)),[M]),T=t.useCallback((e=>{if(K&&!K(M.current.getRowParams(e)))return!1;const t=M.current.getRowNode(e);return"footer"!==t?.type&&"pinnedRow"!==t?.type}),[M,K]),U=t.useCallback((()=>s(M)),[M]),F=t.useCallback(((e,t=!0,o=!1)=>{if(M.current.isRowSelectable(e))if(I.current=e,o)x.debug(`Setting selection for row ${e}`),M.current.setRowSelectionModel(t?[e]:[]);else{x.debug(`Toggling selection for row ${e}`);const o=c(M.current.state).filter((t=>t!==e));t&&o.push(e);(o.length<2||O)&&M.current.setRowSelectionModel(o)}}),[M,x,O]),H=t.useCallback(((t,o=!0,r=!1)=>{x.debug("Setting selection for several rows");const l=t.filter((e=>M.current.isRowSelectable(e)));let i;if(r)i=o?l:[];else{const t=e({},u(M));l.forEach((e=>{o?t[e]=e:delete t[e]})),i=Object.values(t)}(i.length<2||O)&&M.current.setRowSelectionModel(i)}),[M,x,O]),L=t.useCallback((({startId:e,endId:t},o=!0,r=!1)=>{if(!M.current.getRow(e)||!M.current.getRow(t))return;x.debug(`Expanding selection from row ${e} to row ${t}`);const l=d(M),i=l.indexOf(e),n=l.indexOf(t),[c,s]=i>n?[n,i]:[i,n],u=l.slice(c,s+1);M.current.selectRows(u,o,r)}),[M,x]),X={selectRows:H,selectRowRange:L};l(M,{selectRow:F,setRowSelectionModel:$,getSelectedRows:U,isRowSelected:N,isRowSelectable:T},"public"),l(M,X,v.signature===o.DataGrid?"private":"public");const Y=t.useCallback((()=>{if(v.keepNonExistentRowsSelected)return;const t=c(M.current.state),o=n(M),r=e({},u(M));let l=!1;t.forEach((e=>{o[e]||(delete r[e],l=!0)})),l&&M.current.setRowSelectionModel(Object.values(r))}),[M,v.keepNonExistentRowsSelected]),q=t.useCallback(((e,t)=>{const o=t.metaKey||t.ctrlKey,r=!A&&!o&&!g(t),l=!O||r,i=M.current.isRowSelected(e);l?M.current.selectRow(e,!!r||!i,!0):M.current.selectRow(e,!i,!1)}),[M,O,A]),z=t.useCallback(((e,t)=>{if(G)return;const o=t.target.closest(`.${p.cell}`)?.getAttribute("data-field");if(o===k.field)return;if(o===R)return;if(o){const e=M.current.getColumn(o);if(e?.type===y)return}"pinnedRow"!==M.current.getRowNode(e.id).type&&(t.shiftKey&&O?V(e.id):q(e.id,t))}),[G,O,M,V,q]),B=t.useCallback(((e,t)=>{O&&t.shiftKey&&window.getSelection()?.removeAllRanges()}),[O]),J=t.useCallback(((e,t)=>{O&&t.nativeEvent.shiftKey?V(e.id):M.current.selectRow(e.id,e.value,!O)}),[M,V,O]),Q=t.useCallback((e=>{const t=v.checkboxSelectionVisibleOnly&&v.pagination?C(M):d(M),o=w(M);M.current.selectRows(t,e.value,o?.items.length>0)}),[M,v.checkboxSelectionVisibleOnly,v.pagination]),W=t.useCallback(((e,t)=>{if(M.current.getCellMode(e.id,e.field)!==f.Edit&&!b(t)){if(S(t.key)&&t.shiftKey){const o=a(M);if(o&&o.id!==e.id){t.preventDefault();const r=M.current.isRowSelected(o.id);if(!O)return void M.current.selectRow(o.id,!r,!0);const l=M.current.getRowIndexRelativeToVisibleRows(o.id),i=M.current.getRowIndexRelativeToVisibleRows(e.id);let n,c;l>i?r?(n=i,c=l-1):(n=i,c=l):r?(n=l+1,c=i):(n=l,c=i);const s=P.rows.slice(n,c+1).map((e=>e.id));return void M.current.selectRows(s,!r)}}if(" "===t.key&&t.shiftKey)return t.preventDefault(),void q(e.id,t);"a"===t.key&&(t.ctrlKey||t.metaKey)&&(t.preventDefault(),H(M.current.getAllRowIds(),!0))}}),[M,q,H,P.rows,O]);r(M,"sortedRowsSet",D(Y)),r(M,"rowClick",D(z)),r(M,"rowSelectionCheckboxChange",D(J)),r(M,"headerSelectionCheckboxChange",Q),r(M,"cellMouseDown",D(B)),r(M,"cellKeyDown",D(W)),t.useEffect((()=>{void 0!==E&&M.current.setRowSelectionModel(E)}),[M,E,v.rowSelection]),t.useEffect((()=>{v.rowSelection||M.current.setRowSelectionModel([])}),[M,v.rowSelection]);const Z=null!=E;t.useEffect((()=>{if(Z||!v.rowSelection)return;const e=c(M.current.state);if(T){const t=e.filter((e=>T(e)));t.length<e.length&&M.current.setRowSelectionModel(t)}}),[M,T,Z,v.rowSelection]),t.useEffect((()=>{if(!v.rowSelection||Z)return;const e=c(M.current.state);!O&&e.length>1&&M.current.setRowSelectionModel([])}),[M,O,A,Z,v.rowSelection])};export{M as rowSelectionStateInitializer,v as useGridRowSelection};
