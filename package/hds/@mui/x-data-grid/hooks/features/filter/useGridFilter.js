import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as t from"react";import{defaultMemoize as r}from"../../../../../reselect/es/defaultMemoize.js";import{useGridApiEventHandler as l}from"../../utils/useGridApiEventHandler.js";import{useGridApiMethod as i}from"../../utils/useGridApiMethod.js";import{useGridLogger as s}from"../../utils/useGridLogger.js";import{gridColumnLookupSelector as o}from"../columns/gridColumnsSelector.js";import{GridPreferencePanelsValue as n}from"../preferencesPanel/gridPreferencePanelsValue.js";import{getDefaultGridFilterModel as u}from"./gridFilterState.js";import{gridFilterModelSelector as a}from"./gridFilterSelector.js";import{useFirstRender as c}from"../../utils/useFirstRender.js";import{cleanFilterItem as d,mergeStateWithFilterModel as f,sanitizeFilterModel as p,buildAggregatedFilterApplier as m,passFilterLogic as g,shouldQuickFilterExcludeHiddenColumns as F}from"./gridFilterUtils.js";import{isDeepEqual as b}from"../../../utils/utils.js";import{jsx as M}from"react/jsx-runtime";import C from"../../../../utils/useLazyRef/useLazyRef.js";import{gridRowsLookupSelector as k}from"../rows/gridRowsSelector.js";import{useGridRegisterStrategyProcessor as h}from"../../core/strategyProcessing/useGridRegisterStrategyProcessor.js";import S from"../../../../utils/useEnhancedEffect/useEnhancedEffect.js";import{GRID_DEFAULT_STRATEGY as w}from"../../core/strategyProcessing/useGridStrategyProcessing.js";import{useGridRegisterPipeProcessor as y}from"../../core/pipeProcessing/useGridRegisterPipeProcessor.js";const P=(t,r,l)=>{const i=r.filterModel??r.initialState?.filter?.filterModel??u();return e({},t,{filter:{filterModel:p(i,r.disableMultipleColumnsFiltering,l),filteredRowsLookup:{},filteredDescendantCountLookup:{}},visibleRowsLookup:{}})},R=e=>e.filteredRowsLookup;function v(e,t){return e.current.applyStrategyProcessor("visibleRowsLookupCreation",{tree:t.rows.tree,filteredRowsLookup:t.filter.filteredRowsLookup})}function j(){return r(Object.values)}const L=(r,P)=>{const L=s(r,"useGridFilter");r.current.registerControlState({stateId:"filter",propModel:P.filterModel,propOnChange:P.onFilterModelChange,stateSelector:a,changeEvent:"filterModelChange"});const I=t.useCallback((()=>{r.current.setState((t=>{const l=a(t,r.current.instanceId),i=r.current.getFilterState(l),s=e({},t,{filter:e({},t.filter,i)}),o=v(r,s);return e({},s,{visibleRowsLookup:o})})),r.current.publishEvent("filteredRowsSet")}),[r]),E=t.useCallback(((e,t)=>null==t||!1===t.filterable||P.disableColumnFilter?e:[...e,"columnMenuFilterItem"]),[P.disableColumnFilter]),O=t.useCallback((()=>{I(),r.current.forceUpdate()}),[r,I]),V=t.useCallback((t=>{const l=a(r),i=[...l.items],s=i.findIndex((e=>e.id===t.id));-1===s?i.push(t):i[s]=t,r.current.setFilterModel(e({},l,{items:i}),"upsertFilterItem")}),[r]),x=t.useCallback((t=>{const l=a(r),i=[...l.items];t.forEach((e=>{const t=i.findIndex((t=>t.id===e.id));-1===t?i.push(e):i[t]=e})),r.current.setFilterModel(e({},l,{items:i}),"upsertFilterItems")}),[r]),G=t.useCallback((t=>{const l=a(r),i=l.items.filter((e=>e.id!==t.id));i.length!==l.items.length&&r.current.setFilterModel(e({},l,{items:i}),"deleteFilterItem")}),[r]),D=t.useCallback(((t,l,i)=>{if(L.debug("Displaying filter panel"),t){const l=a(r),i=l.items.filter((e=>{if(void 0!==e.value)return!Array.isArray(e.value)||0!==e.value.length;const t=r.current.getColumn(e.field),l=t.filterOperators?.find((t=>t.value===e.operator));return!(void 0===l?.requiresFilterValue||l?.requiresFilterValue)}));let s;const o=i.find((e=>e.field===t)),n=r.current.getColumn(t);s=o?i:P.disableMultipleColumnsFiltering?[d({field:t,operator:n.filterOperators[0].value},r)]:[...i,d({field:t,operator:n.filterOperators[0].value},r)],r.current.setFilterModel(e({},l,{items:s}))}r.current.showPreferences(n.filters,l,i)}),[r,L,P.disableMultipleColumnsFiltering]),_=t.useCallback((()=>{L.debug("Hiding filter panel"),r.current.hidePreferences()}),[r,L]),q=t.useCallback((t=>{const l=a(r);l.logicOperator!==t&&r.current.setFilterModel(e({},l,{logicOperator:t}),"changeLogicOperator")}),[r]),A=t.useCallback((t=>{const l=a(r);b(l.quickFilterValues,t)||r.current.setFilterModel(e({},l,{quickFilterValues:[...t]}))}),[r]),U=t.useCallback(((e,t)=>{a(r)!==e&&(L.debug("Setting filter model"),r.current.updateControlState("filter",f(e,P.disableMultipleColumnsFiltering,r),t),r.current.unstable_applyFilters())}),[r,L,P.disableMultipleColumnsFiltering]),z=t.useCallback((t=>{const l=p(t,P.disableMultipleColumnsFiltering,r),i="client"===P.filterMode?m(l,r,P.disableEval):null,s=r.current.applyStrategyProcessor("filtering",{isRowMatchingFilters:i,filterModel:l??u()});return e({},s,{filterModel:l})}),[P.disableMultipleColumnsFiltering,P.filterMode,P.disableEval,r]),Q={setFilterLogicOperator:q,unstable_applyFilters:O,deleteFilterItem:G,upsertFilterItem:V,upsertFilterItems:x,setFilterModel:U,showFilterPanel:D,hideFilterPanel:_,setQuickFilterValues:A,ignoreDiacritics:P.ignoreDiacritics,getFilterState:z};i(r,Q,"public");const H=t.useCallback(((t,l)=>{const i=a(r);return!l.exportOnlyDirtyModels||null!=P.filterModel||null!=P.initialState?.filter?.filterModel||!b(i,u())?e({},t,{filter:{filterModel:i}}):t}),[r,P.filterModel,P.initialState?.filter?.filterModel]),T=t.useCallback(((t,l)=>{const i=l.stateToRestore.filter?.filterModel;return null==i?t:(r.current.updateControlState("filter",f(i,P.disableMultipleColumnsFiltering,r),"restoreState"),e({},t,{callbacks:[...t.callbacks,r.current.unstable_applyFilters]}))}),[r,P.disableMultipleColumnsFiltering]),B=t.useCallback(((t,r)=>{if(r===n.filters){const t=P.slots.filterPanel;return M(t,e({},P.slotProps?.filterPanel))}return t}),[P.slots.filterPanel,P.slotProps?.filterPanel]),{getRowId:J}=P,K=C(j),N=t.useCallback((e=>{if("client"!==P.filterMode||!e.isRowMatchingFilters)return{filteredRowsLookup:{},filteredDescendantCountLookup:{}};const t=k(r),l={},{isRowMatchingFilters:i}=e,s={},o={passingFilterItems:null,passingQuickFilterValues:null},n=K.current(r.current.state.rows.dataRowIdToModelLookup);for(let t=0;t<n.length;t+=1){const u=n[t],a=J?J(u):u.id;i(u,void 0,o);const c=g([o.passingFilterItems],[o.passingQuickFilterValues],e.filterModel,r,s);l[a]=c}const u="auto-generated-group-footer-root";return t[u]&&(l[u]=!0),{filteredRowsLookup:l,filteredDescendantCountLookup:{}}}),[r,P.filterMode,J,K]);y(r,"columnMenu",E),y(r,"exportState",H),y(r,"restoreState",T),y(r,"preferencePanel",B),h(r,w,"filtering",N),h(r,w,"visibleRowsLookupCreation",R);const W=t.useCallback((()=>{L.debug("onColUpdated - GridColumns changed, applying filters");const t=a(r),l=o(r),i=t.items.filter((e=>e.field&&l[e.field]));i.length<t.items.length&&r.current.setFilterModel(e({},t,{items:i}))}),[r,L]),X=t.useCallback((e=>{"filtering"===e&&r.current.unstable_applyFilters()}),[r]),Y=t.useCallback((()=>{r.current.setState((t=>e({},t,{visibleRowsLookup:v(r,t)}))),r.current.forceUpdate()}),[r]);l(r,"rowsSet",I),l(r,"columnsChange",W),l(r,"activeStrategyProcessorChange",X),l(r,"rowExpansionChange",Y),l(r,"columnVisibilityModelChange",(()=>{const e=a(r);e.quickFilterValues&&F(e)&&r.current.unstable_applyFilters()})),c((()=>{r.current.unstable_applyFilters()})),S((()=>{void 0!==P.filterModel&&r.current.setFilterModel(P.filterModel)}),[r,L,P.filterModel])};export{P as filterStateInitializer,L as useGridFilter};
