import*as e from"react";import{gridVisibleColumnDefinitionsSelector as r}from"../columns/gridColumnsSelector.js";import{useGridLogger as t}from"../../utils/useGridLogger.js";import{useGridApiEventHandler as n}from"../../utils/useGridApiEventHandler.js";import{gridExpandedSortedRowEntriesSelector as l}from"../filter/gridFilterSelector.js";import{useGridVisibleRows as o}from"../../utils/useGridVisibleRows.js";import{GRID_CHECKBOX_SELECTION_COL_DEF as i}from"../../../colDef/gridCheckboxSelectionColDef.js";import{gridClasses as s}from"../../../constants/gridClasses.js";import{GridCellModes as a}from"../../../models/gridEditRowModel.js";import{isNavigationKey as c}from"../../../utils/keyboardUtils.js";import{GRID_DETAIL_PANEL_TOGGLE_FIELD as d}from"../../../constants/gridDetailPanelToggleField.js";import{gridPinnedRowsSelector as u}from"../rows/gridRowsSelector.js";import{gridColumnGroupsHeaderMaxDepthSelector as f}from"../columnGrouping/gridColumnGroupsSelector.js";import{gridHeaderFilteringEditFieldSelector as g,gridHeaderFilteringMenuSelector as m}from"../headerFiltering/gridHeaderFilteringSelectors.js";import{isEventTargetInPortal as b}from"../../../utils/domUtils.js";import C from"../../../../material/styles/useTheme.js";import{gridFocusColumnGroupHeaderSelector as k}from"../focus/gridFocusStateSelector.js";import{useGridRegisterPipeProcessor as p}from"../../core/pipeProcessing/useGridRegisterPipeProcessor.js";const h=({currentColIndex:e,firstColIndex:r,lastColIndex:t,direction:n})=>{if("rtl"===n){if(e<t)return e+1}else if("ltr"===n&&e>r)return e-1;return null},x=({currentColIndex:e,firstColIndex:r,lastColIndex:t,direction:n})=>{if("rtl"===n){if(e>r)return e-1}else if("ltr"===n&&e<t)return e+1;return null},w=(w,I)=>{const y=t(w,"useGridKeyboardNavigation"),D=o(w,I).rows,j=C(),A=e.useMemo((()=>function(e,r){const t=u(e)||{};return[...t.top||[],...r,...t.bottom||[]]}(w,D)),[w,D]),K="DataGrid"!==I.signature&&I.headerFilters,P=e.useCallback(((e,r,t="left")=>{const n=l(w),o=w.current.unstable_getCellColSpanInfo(r,e);o&&o.spannedByColSpan&&("left"===t?e=o.leftVisibleCellIndex:"right"===t&&(e=o.rightVisibleCellIndex));const i=n.findIndex((e=>e.id===r));y.debug(`Navigating to cell row ${i}, col ${e}`),w.current.scrollToIndexes({colIndex:e,rowIndex:i});const s=w.current.getVisibleColumns()[e].field;w.current.setCellFocus(r,s)}),[w,y]),S=e.useCallback(((e,r)=>{y.debug(`Navigating to header col ${e}`),w.current.scrollToIndexes({colIndex:e});const t=w.current.getVisibleColumns()[e].field;w.current.setColumnHeaderFocus(t,r)}),[w,y]),F=e.useCallback(((e,r)=>{y.debug(`Navigating to header filter col ${e}`),w.current.scrollToIndexes({colIndex:e});const t=w.current.getVisibleColumns()[e].field;w.current.setColumnHeaderFilterFocus(t,r)}),[w,y]),H=e.useCallback(((e,r,t)=>{y.debug(`Navigating to header col ${e}`),w.current.scrollToIndexes({colIndex:e});const{field:n}=w.current.getVisibleColumns()[e];w.current.setColumnGroupHeaderFocus(n,r,t)}),[w,y]),v=e.useCallback((e=>A[e]?.id),[A]),V=e.useCallback(((e,t)=>{const n=t.currentTarget.querySelector(`.${s.columnHeaderTitleContainerContent}`);if(!!n&&n.contains(t.target)&&e.field!==i.field)return;const l=w.current.getViewportPageSize(),o=e.field?w.current.getColumnIndex(e.field):0,a=A.length>0?0:null,c=A.length-1,d=r(w).length-1,u=f(w);let g=!0;switch(t.key){case"ArrowDown":null!==a&&(K?F(o,t):P(o,v(a)));break;case"ArrowRight":{const e=x({currentColIndex:o,firstColIndex:0,lastColIndex:d,direction:j.direction});null!==e&&S(e,t);break}case"ArrowLeft":{const e=h({currentColIndex:o,firstColIndex:0,lastColIndex:d,direction:j.direction});null!==e&&S(e,t);break}case"ArrowUp":u>0&&H(o,u-1,t);break;case"PageDown":null!==a&&null!==c&&P(o,v(Math.min(a+l,c)));break;case"Home":S(0,t);break;case"End":S(d,t);break;case"Enter":(t.ctrlKey||t.metaKey)&&w.current.toggleColumnMenu(e.field);break;case" ":break;default:g=!1}g&&t.preventDefault()}),[w,A.length,K,F,P,v,j.direction,S,H]),G=e.useCallback(((e,t)=>{const n=g(w)===e.field,l=m(w)===e.field;if(n||l||!c(t.key))return;const o=w.current.getViewportPageSize(),i=e.field?w.current.getColumnIndex(e.field):0,s=A.length-1,a=r(w).length-1;let d=!0;switch(t.key){case"ArrowDown":{const e=v(0);null!=e&&P(i,e);break}case"ArrowRight":{const e=x({currentColIndex:i,firstColIndex:0,lastColIndex:a,direction:j.direction});null!==e&&F(e,t);break}case"ArrowLeft":{const r=h({currentColIndex:i,firstColIndex:0,lastColIndex:a,direction:j.direction});null!==r?F(r,t):w.current.setColumnHeaderFilterFocus(e.field,t);break}case"ArrowUp":S(i,t);break;case"PageDown":null!==s&&P(i,v(Math.min(0+o,s)));break;case"Home":F(0,t);break;case"End":F(a,t);break;case" ":break;default:d=!1}d&&t.preventDefault()}),[w,A.length,F,j.direction,S,P,v]),M=e.useCallback(((e,t)=>{const n=k(w);if(null===n)return;const{field:l,depth:o}=n,{fields:i,depth:s,maxDepth:a}=e,c=w.current.getViewportPageSize(),d=w.current.getColumnIndex(l),u=l?w.current.getColumnIndex(l):0,f=A.length-1,g=r(w).length-1;let m=!0;switch(t.key){case"ArrowDown":s===a-1?S(d,t):H(d,o+1,t);break;case"ArrowUp":s>0&&H(d,o-1,t);break;case"ArrowRight":{const e=i.length-i.indexOf(l)-1;d+e+1<=g&&H(d+e+1,o,t);break}case"ArrowLeft":{const e=i.indexOf(l);d-e-1>=0&&H(d-e-1,o,t);break}case"PageDown":null!==f&&P(u,v(Math.min(0+c,f)));break;case"Home":H(0,o,t);break;case"End":H(g,o,t);break;case" ":break;default:m=!1}m&&t.preventDefault()}),[w,A.length,S,H,P,v]),E=e.useCallback(((e,t)=>{if(b(t))return;const n=w.current.getCellParams(e.id,e.field);if(n.cellMode===a.Edit||!c(t.key))return;if(!w.current.unstable_applyPipeProcessors("canUpdateFocus",!0,{event:t,cell:n}))return;if(0===A.length)return;const l=j.direction,o=w.current.getViewportPageSize(),i=e.field?w.current.getColumnIndex(e.field):0,s=A.findIndex((r=>r.id===e.id)),u=A.length-1,f=r(w).length-1;let g=!0;switch(t.key){case"ArrowDown":s<u&&P(i,v(s+1));break;case"ArrowUp":s>0?P(i,v(s-1)):K?F(i,t):S(i,t);break;case"ArrowRight":{const e=x({currentColIndex:i,firstColIndex:0,lastColIndex:f,direction:l});null!==e&&P(e,v(s),"rtl"===l?"left":"right");break}case"ArrowLeft":{const e=h({currentColIndex:i,firstColIndex:0,lastColIndex:f,direction:l});null!==e&&P(e,v(s),"rtl"===l?"right":"left");break}case"Tab":t.shiftKey&&i>0?P(i-1,v(s),"left"):!t.shiftKey&&i<f&&P(i+1,v(s),"right");break;case" ":{if(e.field===d)break;const r=e.colDef;if(r&&"__tree_data_group__"===r.field)break;!t.shiftKey&&s<u&&P(i,v(Math.min(s+o,u)));break}case"PageDown":s<u&&P(i,v(Math.min(s+o,u)));break;case"PageUp":{const e=Math.max(s-o,0);e!==s&&e>=0?P(i,v(e)):S(i,t);break}case"Home":t.ctrlKey||t.metaKey||t.shiftKey?P(0,v(0)):P(0,v(s));break;case"End":t.ctrlKey||t.metaKey||t.shiftKey?P(f,v(u)):P(f,v(s));break;default:g=!1}g&&t.preventDefault()}),[w,A,j.direction,P,v,K,F,S]),T=e.useCallback(((e,{event:r})=>" "!==r.key&&e),[]);p(w,"canStartEditing",T),n(w,"columnHeaderKeyDown",V),n(w,"headerFilterKeyDown",G),n(w,"columnGroupHeaderKeyDown",M),n(w,"cellKeyDown",E)};export{w as useGridKeyboardNavigation};
