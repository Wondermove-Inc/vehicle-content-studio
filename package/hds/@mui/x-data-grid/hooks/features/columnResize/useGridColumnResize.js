import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as t from"react";import{findParentElementFromClassName as n,getFieldFromHeaderElem as r,findGridCells as i,findGridHeader as o,getFieldsFromGroupHeaderElem as l,findHeaderElementFromField as u,escapeOperandAttributeSelector as s,findGroupHeaderElementsFromField as c,findGridCellElementsFromCol as d,findGridElement as m,findLeftPinnedCellsAfterCol as a,findRightPinnedCellsBeforeCol as f,findLeftPinnedHeadersAfterCol as h,findRightPinnedHeadersBeforeCol as p}from"../../../utils/domUtils.js";import{DEFAULT_GRID_AUTOSIZE_OPTIONS as g}from"./gridColumnResizeApi.js";import{gridClasses as E}from"../../../constants/gridClasses.js";import{createControllablePromise as v}from"../../../utils/createControllablePromise.js";import{clamp as C}from"../../../utils/utils.js";import{GridPinnedColumnPosition as R}from"../columns/gridColumnsInterfaces.js";import y from"../../../../material/styles/useTheme.js";import W from"../../../../utils/useLazyRef/useLazyRef.js";import z from"../../../../utils/useTimeout/useTimeout.js";import b from"../../../../utils/useEventCallback/useEventCallback.js";import H from"../../../../utils/ownerDocument/ownerDocument.js";import{gridColumnsStateSelector as w}from"../columns/gridColumnsSelector.js";import D from"../../../../utils/useOnMount/useOnMount.js";import{useGridSelector as x}from"../../utils/useGridSelector.js";import{useGridLogger as L}from"../../utils/useGridLogger.js";import{useGridNativeEventListener as S}from"../../utils/useGridNativeEventListener.js";import{useGridApiMethod as P}from"../../utils/useGridApiMethod.js";import{useGridApiEventHandler as $,useGridApiOptionHandler as T}from"../../utils/useGridApiEventHandler.js";import{gridVirtualizationColumnEnabledSelector as j}from"../virtualization/gridVirtualizationSelectors.js";function k(e,t){if(void 0!==t&&e.changedTouches){for(let n=0;n<e.changedTouches.length;n+=1){const r=e.changedTouches[n];if(r.identifier===t)return{x:r.clientX,y:r.clientY}}return!1}return{x:e.clientX,y:e.clientY}}function M(e,t,n,r){let i=e;return i+="Right"===r?t-n.left:n.right-t,i}function F(e){e.preventDefault(),e.stopImmediatePropagation()}function A(e,t,n){const r={},l=e.current.rootElementRef.current;return l.classList.add(E.autosizing),n.forEach((n=>{const l=i(e.current,n.field).map((e=>e.getBoundingClientRect().width??0)),u=t.includeOutliers?l:function(e,t){if(e.length<4)return e;const n=e.slice();n.sort(((e,t)=>e-t));const r=n[Math.floor(.25*n.length)],i=n[Math.floor(.75*n.length)-1],o=i-r,l=o<5?5:o*t;return n.filter((e=>e>r-l&&e<i+l))}(l,t.outliersFactor);if(t.includeHeaders){const t=o(e.current,n.field);if(t){const e=t.querySelector(`.${E.columnHeaderTitle}`),n=t.querySelector(`.${E.columnHeaderTitleContainerContent}`),r=t.querySelector(`.${E.iconButtonContainer}`),i=t.querySelector(`.${E.menuIcon}`),o=e??n,l=window.getComputedStyle(t,null),s=parseInt(l.paddingLeft,10)+parseInt(l.paddingRight,10),c=o.scrollWidth+1+s+(r?.clientWidth??0)+(i?.clientWidth??0);u.push(c)}}const s=n.minWidth!==-1/0&&void 0!==n.minWidth,c=n.maxWidth!==1/0&&void 0!==n.maxWidth,d=s?n.minWidth:0,m=c?n.maxWidth:1/0,a=0===u.length?0:Math.max(...u);r[n.field]=C(a,d,m)})),l.classList.remove(E.autosizing),r}const B=t=>e({},t,{columnResize:{resizingColumnField:""}});function G(){return{colDef:void 0,initialColWidth:0,initialTotalWidth:0,previousMouseClickEvent:void 0,columnHeaderElement:void 0,headerFilterElement:void 0,groupHeaderElements:[],cellElements:[],leftPinnedCellsAfter:[],rightPinnedCellsBefore:[],fillerLeft:void 0,fillerRight:void 0,leftPinnedHeadersAfter:[],rightPinnedHeadersBefore:[]}}const I=(i,o)=>{const B=y(),I=L(i,"useGridColumnResize"),O=W(G).current,V=t.useRef(),q=t.useRef(),U=z(),Y=t.useRef(),_=e=>{I.debug(`Updating width to ${e} for col ${O.colDef.field}`);const t=O.columnHeaderElement.offsetWidth,n=e-t,r=e-O.initialColWidth,o=O.initialTotalWidth+r;i.current.rootElementRef?.current?.style.setProperty("--DataGrid-rowWidth",`${o}px`),O.colDef.computedWidth=e,O.colDef.width=e,O.colDef.flex=0,O.columnHeaderElement.style.width=`${e}px`,O.columnHeaderElement.style.minWidth=`${e}px`,O.columnHeaderElement.style.maxWidth=`${e}px`;const l=O.headerFilterElement;l&&(l.style.width=`${e}px`,l.style.minWidth=`${e}px`,l.style.maxWidth=`${e}px`),O.groupHeaderElements.forEach((t=>{const r=t;let i;i="1"===r.getAttribute("aria-colspan")?`${e}px`:`${r.offsetWidth+n}px`,r.style.width=i,r.style.minWidth=i,r.style.maxWidth=i})),O.cellElements.forEach((t=>{const r=t;let i;i="1"===r.getAttribute("aria-colspan")?`${e}px`:`${r.offsetWidth+n}px`,r.style.setProperty("--width",i)}));const u=i.current.unstable_applyPipeProcessors("isColumnPinned",!1,O.colDef.field);u===R.LEFT&&(X(O.fillerLeft,"width",n),O.leftPinnedCellsAfter.forEach((e=>{X(e,"left",n)})),O.leftPinnedHeadersAfter.forEach((e=>{X(e,"left",n)}))),u===R.RIGHT&&(X(O.fillerRight,"width",n),O.rightPinnedCellsBefore.forEach((e=>{X(e,"right",n)})),O.rightPinnedHeadersBefore.forEach((e=>{X(e,"right",n)})))},N=e=>{if(ne(),O.previousMouseClickEvent){const t=O.previousMouseClickEvent,n=t.timeStamp,r=t.clientX,i=t.clientY;if(e.timeStamp-n<300&&e.clientX===r&&e.clientY===i)return void(O.previousMouseClickEvent=void 0)}if(O.colDef){i.current.setColumnWidth(O.colDef.field,O.colDef.width),I.debug(`Updating col ${O.colDef.field} with new width: ${O.colDef.width}`);const e=w(i.current.state);O.groupHeaderElements.forEach((t=>{const n=t,r=`${l(t).reduce(((t,n)=>!1!==e.columnVisibilityModel[n]?t+e.lookup[n].computedWidth:t),0)}px`;n.style.width=r,n.style.minWidth=r,n.style.maxWidth=r}))}U.start(0,(()=>{i.current.publishEvent("columnResizeStop",null,e)}))},J=(e,t,n)=>{const r=i.current.rootElementRef.current;O.initialColWidth=e.computedWidth,O.initialTotalWidth=i.current.getRootDimensions().rowWidth,O.colDef=e,O.columnHeaderElement=u(i.current.columnHeadersContainerRef.current,e.field);const o=r.querySelector(`.${E.headerFilterRow} [data-field="${s(e.field)}"]`);o&&(O.headerFilterElement=o),O.groupHeaderElements=c(i.current.columnHeadersContainerRef?.current,e.field),O.cellElements=d(O.columnHeaderElement,i.current),O.fillerLeft=m(i.current,"filler--pinnedLeft"),O.fillerRight=m(i.current,"filler--pinnedRight");const l=i.current.unstable_applyPipeProcessors("isColumnPinned",!1,O.colDef.field);O.leftPinnedCellsAfter=l!==R.LEFT?[]:a(i.current,O.columnHeaderElement),O.rightPinnedCellsBefore=l!==R.RIGHT?[]:f(i.current,O.columnHeaderElement),O.leftPinnedHeadersAfter=l!==R.LEFT?[]:h(i.current,O.columnHeaderElement),O.rightPinnedHeadersBefore=l!==R.RIGHT?[]:p(i.current,O.columnHeaderElement),q.current=function(e,t){const n=e.classList.contains(E["columnSeparator--sideRight"])?"Right":"Left";return"rtl"===t?function(e){return"Right"===e?"Left":"Right"}(n):n}(t,B.direction),V.current=function(e,t,n){return"Left"===n?e-t.left:t.right-e}(n,O.columnHeaderElement.getBoundingClientRect(),q.current)},K=b(N),Q=b((e=>{if(0===e.buttons)return void K(e);let t=M(V.current,e.clientX,O.columnHeaderElement.getBoundingClientRect(),q.current);t=C(t,O.colDef.minWidth,O.colDef.maxWidth),_(t);const n={element:O.columnHeaderElement,colDef:O.colDef,width:t};i.current.publishEvent("columnResize",n,e)})),Z=b((e=>{k(e,Y.current)&&N(e)})),ee=b((e=>{const t=k(e,Y.current);if(!t)return;if("mousemove"===e.type&&0===e.buttons)return void Z(e);let n=M(V.current,t.x,O.columnHeaderElement.getBoundingClientRect(),q.current);n=C(n,O.colDef.minWidth,O.colDef.maxWidth),_(n);const r={element:O.columnHeaderElement,colDef:O.colDef,width:n};i.current.publishEvent("columnResize",r,e)})),te=b((e=>{const t=n(e.target,E["columnSeparator--resizable"]);if(!t)return;const o=e.changedTouches[0];null!=o&&(Y.current=o.identifier);const l=n(e.target,E.columnHeader),u=r(l),s=i.current.getColumn(u);I.debug(`Start Resize on col ${s.field}`),i.current.publishEvent("columnResizeStart",{field:u},e),J(s,t,o.clientX);const c=H(e.currentTarget);c.addEventListener("touchmove",ee),c.addEventListener("touchend",Z)})),ne=t.useCallback((()=>{const e=H(i.current.rootElementRef.current);e.body.style.removeProperty("cursor"),e.removeEventListener("mousemove",Q),e.removeEventListener("mouseup",K),e.removeEventListener("touchmove",ee),e.removeEventListener("touchend",Z),setTimeout((()=>{e.removeEventListener("click",F,!0)}),100),O.columnHeaderElement&&(O.columnHeaderElement.style.pointerEvents="unset")}),[i,O,Q,K,ee,Z]),re=t.useCallback((({field:t})=>{i.current.setState((n=>e({},n,{columnResize:e({},n.columnResize,{resizingColumnField:t})}))),i.current.forceUpdate()}),[i]),ie=t.useCallback((()=>{i.current.setState((t=>e({},t,{columnResize:e({},t.columnResize,{resizingColumnField:""})}))),i.current.forceUpdate()}),[i]),oe=b((({colDef:e},t)=>{if(0!==t.button)return;if(!t.currentTarget.classList.contains(E["columnSeparator--resizable"]))return;t.preventDefault(),I.debug(`Start Resize on col ${e.field}`),i.current.publishEvent("columnResizeStart",{field:e.field},t),J(e,t.currentTarget,t.clientX);const n=H(i.current.rootElementRef.current);n.body.style.cursor="col-resize",O.previousMouseClickEvent=t.nativeEvent,n.addEventListener("mousemove",Q),n.addEventListener("mouseup",K),n.addEventListener("click",F,!0)})),le=b(((t,n)=>{if(o.disableAutosize)return;if(0!==n.button)return;const r=i.current.state.columns.lookup[t.field];!1!==r.resizable&&i.current.autosizeColumns(e({},o.autosizeOptions,{columns:[r.field]}))})),ue=function(e){const n=t.useRef(),r=()=>j(e),i=x(e,r);return t.useEffect((()=>{n.current&&!1===i&&(n.current.resolve(),n.current=void 0)})),()=>{if(!n.current){if(!1===r())return Promise.resolve();n.current=v()}return n.current}}(i),se=t.useRef(!1),ce=t.useCallback((async t=>{const n=i.current.rootElementRef?.current;if(!n)return;if(se.current)return;se.current=!0;const r=w(i.current.state),o=e({},g,t,{columns:t?.columns??r.orderedFields});o.columns=o.columns.filter((e=>!1!==r.columnVisibilityModel[e]));const l=o.columns.map((e=>i.current.state.columns.lookup[e]));try{i.current.unstable_setColumnVirtualization(!1),await ue();const t=A(i,o,l),n=l.map((n=>e({},n,{width:t[n.field],computedWidth:t[n.field]})));if(o.expand){const e=r.orderedFields.map((e=>r.lookup[e])).filter((e=>!1!==r.columnVisibilityModel[e.field])).reduce(((e,n)=>e+(t[n.field]??n.computedWidth??n.width)),0),o=i.current.getRootDimensions().viewportInnerSize.width-e;if(o>0){const e=o/(n.length||1);n.forEach((t=>{t.width+=e,t.computedWidth+=e}))}}i.current.updateColumns(n),n.forEach(((e,t)=>{if(e.width!==l[t].width){const t=e.width;i.current.publishEvent("columnWidthChange",{element:i.current.getColumnHeaderElement(e.field),colDef:e,width:t})}}))}finally{i.current.unstable_setColumnVirtualization(!0),se.current=!1}}),[i,ue]);t.useEffect((()=>ne),[ne]),D((()=>{o.autosizeOnMount&&Promise.resolve().then((()=>{i.current.autosizeColumns(o.autosizeOptions)}))})),S(i,(()=>i.current.columnHeadersContainerRef?.current),"touchstart",te,{passive:!0}),P(i,{autosizeColumns:ce},"public"),$(i,"columnResizeStop",ie),$(i,"columnResizeStart",re),$(i,"columnSeparatorMouseDown",oe),$(i,"columnSeparatorDoubleClick",le),T(i,"columnResize",o.onColumnResize),T(i,"columnWidthChange",o.onColumnWidthChange)};function X(e,t,n){e&&(e.style[t]=`${parseInt(e.style[t],10)+n}px`)}export{B as columnResizeStateInitializer,I as useGridColumnResize};
