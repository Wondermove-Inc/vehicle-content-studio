import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import*as t from"react";import*as r from"react-dom";import{useGridPrivateApiContext as o}from"../../utils/useGridPrivateApiContext.js";import{useGridRootProps as n}from"../../utils/useGridRootProps.js";import{useGridSelector as s}from"../../utils/useGridSelector.js";import{useResizeObserver as i}from"../../utils/useResizeObserver.js";import{useRunOnce as l}from"../../utils/useRunOnce.js";import{gridVisibleColumnDefinitionsSelector as u,gridVisiblePinnedColumnDefinitionsSelector as a,gridHasColSpanSelector as f,gridColumnPositionsSelector as c}from"../columns/gridColumnsSelector.js";import{gridDimensionsSelector as d}from"../dimensions/gridDimensionsSelectors.js";import{gridPinnedRowsSelector as m}from"../rows/gridRowsSelector.js";import{gridFocusCellSelector as w,gridTabIndexCellSelector as h}from"../focus/gridFocusStateSelector.js";import{useGridVisibleRows as p,getVisibleRows as g}from"../../utils/useGridVisibleRows.js";import{range as x,clamp as I}from"../../../utils/utils.js";import{selectedIdsLookupSelector as R}from"../rowSelection/gridRowSelectionSelector.js";import{gridRowsMetaSelector as b}from"../rows/gridRowsMetaSelector.js";import{getFirstNonSpannedColumnToRender as C}from"../columns/gridColumnsUtils.js";import{getMinimalContentHeight as v}from"../rows/gridRowsUtils.js";import{gridVirtualizationEnabledSelector as S,gridVirtualizationColumnEnabledSelector as P,gridRenderContextSelector as E}from"./gridVirtualizationSelectors.js";import{EMPTY_RENDER_CONTEXT as H}from"./useGridVirtualization.js";import{jsx as M}from"react/jsx-runtime";import T from"../../../../material/styles/useTheme.js";import j from"../../../../utils/useTimeout/useTimeout.js";import B from"../../../../utils/useLazyRef/useLazyRef.js";import L from"../../../../utils/useEventCallback/useEventCallback.js";import A from"../../../../utils/useEnhancedEffect/useEnhancedEffect.js";import{useGridApiEventHandler as z}from"../../utils/useGridApiEventHandler.js";var N=function(e){return e[e.NONE=0]="NONE",e[e.UP=1]="UP",e[e.DOWN=2]="DOWN",e[e.LEFT=3]="LEFT",e[e.RIGHT=4]="RIGHT",e}(N||{});const F={top:0,left:0},W=Object.freeze(new Map);let O=!1;try{"undefined"!=typeof window&&(O=/jsdom/.test(window.navigator.userAgent))}catch(e){}const G=()=>{const g=o(),I=n(),C=s(g,u),G=s(g,S)&&!O,V=s(g,P)&&!O,U=s(g,d),D=U.viewportOuterSize,Z=s(g,m),q=s(g,a),J=Z.bottom.length>0,[K,Q]=t.useState(W),$=T(),ee=s(g,w),te=s(g,h),re=s(g,b),oe=s(g,R),ne=p(g,I),se=g.current.rootElementRef,ie=g.current.mainElementRef,le=g.current.virtualScrollerRef,ue=t.useRef(null),ae=t.useRef(null),fe=U.contentSize.height,ce=U.columnsTotalWidth,de=s(g,f);i(ie,(()=>g.current.resize()));const me=t.useRef(F),we=t.useRef(F),he=t.useRef(H),pe=s(g,E),ge=j(),xe=t.useRef(void 0),Ie=B((()=>{return e=$.direction,t=I.rowBufferPx,r=I.columnBufferPx,o=15*U.rowHeight,n=300,{direction:N.NONE,buffer:Y(e,N.NONE,t,r,o,n)};var e,t,r,o,n})).current,Re={rowIndex:t.useMemo((()=>ee?ne.rows.findIndex((e=>e.id===ee.id)):-1),[ee,ne.rows]),columnIndex:t.useMemo((()=>ee?C.findIndex((e=>e.field===ee.field)):-1),[ee,C])},be=t.useCallback((t=>{if(_(t,g.current.state.virtualization.renderContext))return;const r=t.firstRowIndex!==he.current.firstRowIndex||t.lastRowIndex!==he.current.lastRowIndex;g.current.setState((r=>e({},r,{virtualization:e({},r.virtualization,{renderContext:t})}))),U.isReady&&r&&(he.current=t,g.current.publishEvent("renderedRowsIntervalChange",t)),we.current=me.current}),[g,U.isReady]),Ce=()=>{const e={top:le.current.scrollTop,left:le.current.scrollLeft},t=e.left-me.current.left,o=e.top-me.current.top,n=0!==t||0!==o;me.current=e;const s=n?function(e,t){if(0===e&&0===t)return N.NONE;return Math.abs(t)>=Math.abs(e)?t>0?N.DOWN:N.UP:e>0?N.RIGHT:N.LEFT}(t,o):N.NONE,i=Math.abs(me.current.top-we.current.top),l=Math.abs(me.current.left-we.current.left),u=i>=U.rowHeight||l>=50,a=Ie.direction!==s;if(!(u||a))return pe;if(a)switch(s){case N.NONE:case N.LEFT:case N.RIGHT:xe.current=void 0;break;default:xe.current=pe}Ie.direction=s,Ie.buffer=Y($.direction,s,I.rowBufferPx,I.columnBufferPx,15*U.rowHeight,300);const f=k(y(g,I,G,V),me.current,Ie);return r.flushSync((()=>{be(f)})),ge.start(1e3,Ce),f},ve=()=>{const e=k(y(g,I,G,V),me.current,Ie);be(e)},Se=L((e=>{const{scrollTop:t,scrollLeft:r}=e.currentTarget;if(t<0)return;if("ltr"===$.direction&&r<0)return;if("rtl"===$.direction&&r>0)return;const o=Ce();g.current.publishEvent("scrollPositionChange",{top:t,left:r,renderContext:o})})),Pe=L((e=>{g.current.publishEvent("virtualScrollerWheel",{},e)})),Ee=L((e=>{g.current.publishEvent("virtualScrollerTouchMove",{},e)})),He=D.width&&ce>=D.width,Me=t.useMemo((()=>({overflowX:He?void 0:"hidden",overflowY:I.autoHeight?"hidden":void 0})),[He,I.autoHeight]),Te=t.useMemo((()=>{const e=Math.max(fe,1),t={width:He?ce:"auto",height:e};return I.autoHeight&&(0===ne.rows.length?t.height=v(g):t.height=fe),t}),[g,ce,fe,He,I.autoHeight,ne.rows.length]);return t.useEffect((()=>{g.current.publishEvent("virtualScrollerContentSizeChange")}),[g,Te]),A((()=>{g.current.resize()}),[g,re.currentPageTotalHeight]),A((()=>{G&&(le.current.scrollLeft=0,le.current.scrollTop=0)}),[G,se,le]),l(0!==D.width,(()=>{const e=k(y(g,I,G,V),me.current,Ie);be(e),g.current.publishEvent("scrollPositionChange",{top:me.current.top,left:me.current.left,renderContext:e})})),g.current.register("private",{updateRenderContext:ve}),z(g,"columnsChange",ve),z(g,"filteredRowsSet",ve),z(g,"rowExpansionChange",ve),{renderContext:pe,setPanels:Q,getRows:(t={})=>{if(!t.rows&&!ne.range)return[];const r=t.renderContext??pe,o=!J&&void 0===t.position||J&&"bottom"===t.position,n=void 0!==t.position;let s;switch(t.position){case"top":s=0;break;case"bottom":s=Z.top.length+ne.rows.length;break;case void 0:s=Z.top.length}const i=t.rows??ne.rows,l=r.firstRowIndex,u=Math.min(r.lastRowIndex,i.length),a=t.rows?x(0,t.rows.length):x(l,u);let f=-1;n||-1===Re.rowIndex||(Re.rowIndex<l&&(f=Re.rowIndex,a.unshift(f)),Re.rowIndex>=u&&(f=Re.rowIndex,a.push(f)));const d=[],m=I.slotProps?.row,w=c(g);return a.forEach((l=>{const{id:u,model:a}=i[l];if(de){const e=q.left.length,t=C.length-q.right.length;g.current.calculateColSpan({rowId:u,minFirstColumn:e,maxLastColumn:t,columns:C}),q.left.length>0&&g.current.calculateColSpan({rowId:u,minFirstColumn:0,maxLastColumn:q.left.length,columns:C}),q.right.length>0&&g.current.calculateColSpan({rowId:u,minFirstColumn:C.length-q.right.length,maxLastColumn:C.length,columns:C})}const c=ee?.id===u,h=g.current.rowHasAutoHeight(u)?"auto":g.current.unstable_getRowHeight(u);let p;p=null!=oe[u]&&g.current.isRowSelectable(u);let x=!1;void 0===t.position&&(x=0===l);let R=!1;if(o)if(n)R=l===i.length-1;else{l===ne.rows.length-1&&(R=!0)}const b=l===f;let v=null;if(null!==te&&te.id===u){v="view"===g.current.getCellParams(u,te.field).cellMode?te.field:null}let S=r;!n&&xe.current&&l>=xe.current.firstRowIndex&&l<xe.current.lastRowIndex&&(S=xe.current);const P=X(w,S,$.direction,q.left.length),E=(ne?.range?.firstRowIndex||0)+s+l;if(d.push(M(I.slots.row,e({row:a,rowId:u,index:E,selected:p,offsetTop:t.rows?void 0:re.positions[l],offsetLeft:P,dimensions:U,rowHeight:h,tabbableCell:v,pinnedColumns:q,visibleColumns:C,renderContext:S,focusedColumnIndex:c?Re.columnIndex:void 0,isFirstVisible:x,isLastVisible:R,isNotVisible:b},m),u)),b)return;const H=K.get(u);H&&d.push(H),R&&d.push(g.current.getInfiniteLoadingTriggerElement?.({lastRowId:u}))})),d},getContainerProps:()=>({ref:ie}),getScrollerProps:()=>({ref:le,tabIndex:-1,onScroll:Se,onWheel:Pe,onTouchMove:Ee,style:Me,role:"presentation"}),getContentProps:()=>({style:Te,role:"presentation"}),getRenderZoneProps:()=>({role:"rowgroup"}),getScrollbarVerticalProps:()=>({ref:ue,role:"presentation"}),getScrollbarHorizontalProps:()=>({ref:ae,role:"presentation"})}};function y(e,t,r,o){const n=d(e.current.state),s=g(e,t),i=u(e),l=e.current.state.rows.dataRowIds.at(-1),f=i.at(-1);return{enabled:r,enabledForColumns:o,apiRef:e,autoHeight:t.autoHeight,rowBufferPx:t.rowBufferPx,columnBufferPx:t.columnBufferPx,leftPinnedWidth:n.leftPinnedWidth,columnsTotalWidth:n.columnsTotalWidth,viewportInnerWidth:n.viewportInnerSize.width,viewportInnerHeight:n.viewportInnerSize.height,lastRowHeight:void 0!==l?e.current.unstable_getRowHeight(l):0,lastColumnWidth:f?.computedWidth??0,rowsMeta:b(e.current.state),columnPositions:c(e),rows:s.rows,range:s.range,pinnedColumns:a(e),visibleColumns:i}}function k(e,t,r){let o;if(e.enabled){const{top:n,left:s}=t,i=Math.abs(s)+e.leftPinnedWidth,l=Math.min(V(e,n,{atStart:!0,lastPosition:e.rowsMeta.positions[e.rowsMeta.positions.length-1]+e.lastRowHeight}),e.rowsMeta.positions.length-1),u=e.autoHeight?l+e.rows.length:V(e,n+e.viewportInnerHeight);let a=0,f=e.columnPositions.length;if(e.enabledForColumns){let t=!1;const[o,n]=D({firstIndex:l,lastIndex:u,minFirstIndex:0,maxLastIndex:e.rows.length,bufferBefore:r.buffer.rowBefore,bufferAfter:r.buffer.rowAfter,positions:e.rowsMeta.positions,lastSize:e.lastRowHeight});for(let r=o;r<n&&!t;r+=1){const o=e.rows[r];t=e.apiRef.current.rowHasAutoHeight(o.id)}t||(a=U(i,e.columnPositions,{atStart:!0,lastPosition:e.columnsTotalWidth}),f=U(i+e.viewportInnerWidth,e.columnPositions))}o={firstRowIndex:l,lastRowIndex:u,firstColumnIndex:a,lastColumnIndex:f}}else o={firstRowIndex:0,lastRowIndex:e.rows.length,firstColumnIndex:0,lastColumnIndex:e.visibleColumns.length};const n=function(e,t,r){const[o,n]=D({firstIndex:t.firstRowIndex,lastIndex:t.lastRowIndex,minFirstIndex:0,maxLastIndex:e.rows.length,bufferBefore:r.buffer.rowBefore,bufferAfter:r.buffer.rowAfter,positions:e.rowsMeta.positions,lastSize:e.lastRowHeight}),[s,i]=D({firstIndex:t.firstColumnIndex,lastIndex:t.lastColumnIndex,minFirstIndex:e.pinnedColumns.left.length,maxLastIndex:e.visibleColumns.length-e.pinnedColumns.right.length,bufferBefore:r.buffer.columnBefore,bufferAfter:r.buffer.columnAfter,positions:e.columnPositions,lastSize:e.lastColumnWidth}),l=C({firstColumnToRender:s,apiRef:e.apiRef,firstRowToRender:o,lastRowToRender:n,visibleRows:e.rows});return{firstRowIndex:o,lastRowIndex:n,firstColumnIndex:l,lastColumnIndex:i}}(e,o,r);return n}function V(e,t,r){const o=e.apiRef.current.getLastMeasuredRowIndex();let n=o===1/0;e.range?.lastRowIndex&&!n&&(n=o>=e.range.lastRowIndex);const s=I(o-(e.range?.firstRowIndex||0),0,e.rowsMeta.positions.length);return n||e.rowsMeta.positions[s]>=t?U(t,e.rowsMeta.positions,r):function(e,t,r,o){let n=1;for(;r<t.length&&Math.abs(t[r])<e;)r+=n,n*=2;return U(e,t,o,Math.floor(r/2),Math.min(r,t.length))}(t,e.rowsMeta.positions,s,r)}function U(e,t,r=void 0,o=0,n=t.length){if(t.length<=0)return-1;if(o>=n)return o;const s=o+Math.floor((n-o)/2),i=t[s];let l;if(r?.atStart){l=e-((s===t.length-1?r.lastPosition:t[s+1])-i)<i}else l=e<=i;return l?U(e,t,r,o,s):U(e,t,r,s+1,n)}function D({firstIndex:e,lastIndex:t,bufferBefore:r,bufferAfter:o,minFirstIndex:n,maxLastIndex:s,positions:i,lastSize:l}){const u=i[e]-r,a=i[t]+o,f=U(u,i,{atStart:!0,lastPosition:i[i.length-1]+l}),c=U(a,i);return[I(f,n,s),I(c,n,s)]}function _(e,t){return e===t||e.firstRowIndex===t.firstRowIndex&&e.lastRowIndex===t.lastRowIndex&&e.firstColumnIndex===t.firstColumnIndex&&e.lastColumnIndex===t.lastColumnIndex}function X(e,t,r,o){const n=("ltr"===r?1:-1)*(e[t.firstColumnIndex]??0)-(e[o]??0);return Math.abs(n)}function Y(e,t,r,o,n,s){if("rtl"===e)switch(t){case N.LEFT:t=N.RIGHT;break;case N.RIGHT:t=N.LEFT}switch(t){case N.NONE:return{rowAfter:r,rowBefore:r,columnAfter:o,columnBefore:o};case N.LEFT:return{rowAfter:0,rowBefore:0,columnAfter:0,columnBefore:s};case N.RIGHT:return{rowAfter:0,rowBefore:0,columnAfter:s,columnBefore:0};case N.UP:return{rowAfter:0,rowBefore:n,columnAfter:0,columnBefore:0};case N.DOWN:return{rowAfter:n,rowBefore:0,columnAfter:0,columnBefore:0};default:throw new Error("unreachable")}}export{W as EMPTY_DETAIL_PANELS,_ as areRenderContextsEqual,X as computeOffsetLeft,G as useGridVirtualScroller};
