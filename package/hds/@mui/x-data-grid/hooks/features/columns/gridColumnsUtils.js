import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import{gridColumnsStateSelector as t,gridColumnVisibilityModelSelector as o}from"./gridColumnsSelector.js";import{clamp as l}from"../../../utils/utils.js";import{gridDensityFactorSelector as i}from"../density/densitySelector.js";import{gridHeaderFilteringEnabledSelector as r}from"../headerFiltering/gridHeaderFilteringSelectors.js";import{gridColumnGroupsHeaderMaxDepthSelector as n}from"../columnGrouping/gridColumnGroupsSelector.js";import{GRID_STRING_COL_DEF as s}from"../../../colDef/gridStringColDef.js";import{DEFAULT_GRID_COL_TYPE_KEY as d,getGridDefaultColumnTypes as f}from"../../../colDef/gridDefaultColumnTypes.js";const c=["maxWidth","minWidth","width","flex"],u=f();function a({initialFreeSpace:e,totalFlexUnits:t,flexColumns:o}){const l=new Set(o.map((e=>e.field))),i={all:{},frozenFields:[],freeze:e=>{const t=i.all[e];t&&!0!==t.frozen&&(i.all[e].frozen=!0,i.frozenFields.push(e))}};return function r(){if(i.frozenFields.length===l.size)return;const n={min:{},max:{}};let s=e,d=t,f=0;i.frozenFields.forEach((e=>{s-=i.all[e].computedWidth,d-=i.all[e].flex}));for(let e=0;e<o.length;e+=1){const t=o[e];if(i.all[t.field]&&!0===i.all[t.field].frozen)continue;let l=s/d*t.flex;l<t.minWidth?(f+=t.minWidth-l,l=t.minWidth,n.min[t.field]=!0):l>t.maxWidth&&(f+=t.maxWidth-l,l=t.maxWidth,n.max[t.field]=!0),i.all[t.field]={frozen:!1,computedWidth:l,flex:t.flex}}f<0?Object.keys(n.max).forEach((e=>{i.freeze(e)})):f>0?Object.keys(n.min).forEach((e=>{i.freeze(e)})):o.forEach((({field:e})=>{i.freeze(e)})),r()}(),i.all}const m=(t,o)=>{const i={};let r=0,n=0;const d=[];t.orderedFields.forEach((o=>{let f=t.lookup[o],c=0,u=!1;!1!==t.columnVisibilityModel[o]&&(f.flex&&f.flex>0?(r+=f.flex,u=!0):c=l(f.width||s.width,f.minWidth||s.minWidth,f.maxWidth||s.maxWidth),n+=c),f.computedWidth!==c&&(f=e({},f,{computedWidth:c})),u&&d.push(f),i[o]=f}));const f=void 0===o?0:o.viewportOuterSize.width-(o.hasScrollY?o.scrollbarSize:0),c=Math.max(f-n,0);if(r>0&&f>0){const e=a({initialFreeSpace:c,totalFlexUnits:r,flexColumns:d});Object.keys(e).forEach((t=>{i[t].computedWidth=e[t].computedWidth}))}return e({},t,{lookup:i})},h=(t,o)=>{if(!o)return t;const{orderedFields:l=[],dimensions:i={}}=o,r=Object.keys(i);if(0===r.length&&0===l.length)return t;const n={},s=[];for(let e=0;e<l.length;e+=1){const o=l[e];t.lookup[o]&&(n[o]=!0,s.push(o))}const d=0===s.length?t.orderedFields:[...s,...t.orderedFields.filter((e=>!n[e]))],f=e({},t.lookup);for(let t=0;t<r.length;t+=1){const o=r[t],l=e({},f[o],{hasBeenResized:!0});Object.entries(i[o]).forEach((([e,t])=>{l[e]=-1===t?1/0:t})),f[o]=l}return e({},t,{orderedFields:d,lookup:f})};function p(e){let t=u[d];return e&&u[e]&&(t=u[e]),t}const x=({apiRef:l,columnsToUpsert:i,initialState:r,columnVisibilityModel:n=o(l),keepOnlyColumnsToUpsert:s=!1})=>{const d=!l.current.state.columns;let f;if(d)f={orderedFields:[],lookup:{},columnVisibilityModel:n};else{const o=t(l.current.state);f={orderedFields:s?[]:[...o.orderedFields],lookup:e({},o.lookup),columnVisibilityModel:n}}let u={};s&&!d&&(u=Object.keys(f.lookup).reduce(((t,o)=>e({},t,{[o]:!1})),{})),i.forEach((t=>{const{field:o}=t;u[o]=!0;let l=f.lookup[o];null==l?(l=e({},p(t.type),{field:o,hasBeenResized:!1}),f.orderedFields.push(o)):s&&f.orderedFields.push(o),l&&l.type!==t.type&&(l=e({},p(t.type),{field:o}));let i=l.hasBeenResized;c.forEach((e=>{void 0!==t[e]&&(i=!0,-1===t[e]&&(t[e]=1/0))})),f.lookup[o]=e({},l,t,{hasBeenResized:i})})),s&&!d&&Object.keys(f.lookup).forEach((e=>{u[e]||delete f.lookup[e]}));const a=l.current.unstable_applyPipeProcessors("hydrateColumns",f),x=h(a,r);return m(x,l.current.getRootDimensions?.()??void 0)};function g({firstColumnToRender:e,apiRef:t,firstRowToRender:o,lastRowToRender:l,visibleRows:i}){let r=e;for(let n=o;n<l;n+=1){if(i[n]){const o=i[n].id,l=t.current.unstable_getCellColSpanInfo(o,e);l&&l.spannedByColSpan&&(r=l.leftVisibleCellIndex)}}return r}function y(e,t){const o=i(e),l=n(e),s=r(e);return Math.floor(t.columnHeaderHeight*o)*(1+(l??0))+(s?Math.floor((t.headerFilterHeight??t.columnHeaderHeight)*o):0)}export{c as COLUMNS_DIMENSION_PROPERTIES,h as applyInitialState,a as computeFlexColumnsWidth,x as createColumnsState,g as getFirstNonSpannedColumnToRender,y as getTotalHeaderHeight,m as hydrateColumnsWidth};
