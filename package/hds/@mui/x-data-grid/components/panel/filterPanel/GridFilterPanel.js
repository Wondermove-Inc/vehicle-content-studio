import e from"../../../../../@babel/runtime/helpers/esm/extends.js";import t from"../../../../../@babel/runtime/helpers/esm/objectWithoutPropertiesLoose.js";import*as r from"react";import l from"../../../../../prop-types/index.js";import{GridLogicOperator as o}from"../../../models/gridFilterItem.js";import{useGridApiContext as i}from"../../../hooks/utils/useGridApiContext.js";import{GridPanelContent as n}from"../GridPanelContent.js";import{GridPanelFooter as s}from"../GridPanelFooter.js";import{GridPanelWrapper as u}from"../GridPanelWrapper.js";import{GridFilterForm as a}from"./GridFilterForm.js";import{useGridRootProps as c}from"../../../hooks/utils/useGridRootProps.js";import{useGridSelector as p}from"../../../hooks/utils/useGridSelector.js";import{gridFilterModelSelector as m}from"../../../hooks/features/filter/gridFilterSelector.js";import{gridFilterableColumnDefinitionsSelector as d,gridFilterableColumnLookupSelector as f}from"../../../hooks/features/columns/gridColumnsSelector.js";import{jsxs as F,jsx as h}from"react/jsx-runtime";const g=["logicOperators","columnsSort","filterFormProps","getColumnForNewFilter","children","disableAddFilterButton","disableRemoveAllButton"],O=e=>({field:e.field,operator:e.filterOperators[0].value,id:Math.round(1e5*Math.random())}),b=r.forwardRef((function(l,b){const y=i(),P=c(),C=p(y,m),j=p(y,d),v=p(y,f),I=r.useRef(null),M=r.useRef(null),{logicOperators:k=[o.And,o.Or],columnsSort:A,filterFormProps:R,getColumnForNewFilter:B,disableAddFilterButton:S=!1,disableRemoveAllButton:x=!1}=l,G=t(l,g),w=y.current.upsertFilterItem,E=r.useCallback((e=>{y.current.setFilterLogicOperator(e)}),[y]),N=r.useCallback((()=>{let e;if(B&&"function"==typeof B){const t=B({currentFilters:C?.items||[],columns:j});if(null===t)return null;e=j.find((({field:e})=>e===t))}else e=j.find((e=>e.filterOperators?.length));return e?O(e):null}),[C?.items,j,B]),T=r.useCallback((()=>{if(void 0===B||"function"!=typeof B)return N();const e=C.items.length?C.items:[N()].filter(Boolean),t=B({currentFilters:e,columns:j});if(null===t)return null;const r=j.find((({field:e})=>e===t));return r?O(r):null}),[C.items,j,B,N]),L=r.useMemo((()=>C.items.length?C.items:(M.current||(M.current=N()),M.current?[M.current]:[])),[C.items,N]),W=L.length>1,{readOnlyFilters:q,validFilters:D}=r.useMemo((()=>L.reduce(((e,t)=>(v[t.field]?e.validFilters.push(t):e.readOnlyFilters.push(t),e)),{readOnlyFilters:[],validFilters:[]})),[L,v]),V=r.useCallback((()=>{const e=T();e&&y.current.upsertFilterItems([...L,e])}),[y,T,L]),_=r.useCallback((e=>{const t=1===D.length;y.current.deleteFilterItem(e),t&&y.current.hideFilterPanel()}),[y,D.length]),z=r.useCallback((()=>1===D.length&&void 0===D[0].value?(y.current.deleteFilterItem(D[0]),y.current.hideFilterPanel()):y.current.setFilterModel(e({},C,{items:q}),"removeAllFilterItems")),[y,q,C,D]);return r.useEffect((()=>{k.length>0&&C.logicOperator&&!k.includes(C.logicOperator)&&E(k[0])}),[k,E,C.logicOperator]),r.useEffect((()=>{D.length>0&&I.current.focus()}),[D.length]),F(u,e({ref:b},G,{children:[F(n,{children:[q.map(((t,r)=>h(a,e({item:t,applyFilterChanges:w,deleteFilter:_,hasMultipleFilters:W,showMultiFilterOperators:r>0,disableMultiFilterOperator:1!==r,applyMultiFilterOperatorChanges:E,focusElementRef:null,readOnly:!0,logicOperators:k,columnsSort:A},R),null==t.id?r:t.id))),D.map(((t,r)=>h(a,e({item:t,applyFilterChanges:w,deleteFilter:_,hasMultipleFilters:W,showMultiFilterOperators:q.length+r>0,disableMultiFilterOperator:q.length+r!==1,applyMultiFilterOperatorChanges:E,focusElementRef:r===D.length-1?I:null,logicOperators:k,columnsSort:A},R),null==t.id?r+q.length:t.id)))]}),P.disableMultipleColumnsFiltering||S&&x?null:F(s,{children:[S?h("span",{}):h(P.slots.baseButton,e({onClick:V,startIcon:h(P.slots.filterPanelAddIcon,{})},P.slotProps?.baseButton,{children:y.current.getLocaleText("filterPanelAddFilter")})),!x&&D.length>0?h(P.slots.baseButton,e({onClick:z,startIcon:h(P.slots.filterPanelRemoveAllIcon,{})},P.slotProps?.baseButton,{children:y.current.getLocaleText("filterPanelRemoveAll")})):null]})]}))}));"production"!==process.env.NODE_ENV&&(b.propTypes={children:l.node,columnsSort:l.oneOf(["asc","desc"]),disableAddFilterButton:l.bool,disableRemoveAllButton:l.bool,filterFormProps:l.shape({columnInputProps:l.any,columnsSort:l.oneOf(["asc","desc"]),deleteIconProps:l.any,filterColumns:l.func,logicOperatorInputProps:l.any,operatorInputProps:l.any,valueInputProps:l.any}),getColumnForNewFilter:l.func,logicOperators:l.arrayOf(l.oneOf(["and","or"]).isRequired),sx:l.oneOfType([l.arrayOf(l.oneOfType([l.func,l.object,l.bool])),l.func,l.object])});export{b as GridFilterPanel,O as getGridFilter};
