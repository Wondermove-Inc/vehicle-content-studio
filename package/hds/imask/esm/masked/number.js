import{escapeRegExp as t,DIRECTION as s}from"../core/utils.js";import e from"../core/change-details.js";import a from"./base.js";import i from"../core/holder.js";var r;class h extends a{constructor(t){super({...h.DEFAULTS,...t})}updateOptions(t){super.updateOptions(t)}_update(t){super._update(t),this._updateRegExps()}_updateRegExps(){const s="^"+(this.allowNegative?"[+|\\-]?":""),e=(this.scale?"("+t(this.radix)+"\\d{0,"+this.scale+"})?":"")+"$";this._numberRegExp=new RegExp(s+"\\d*"+e),this._mapToRadixRegExp=new RegExp("["+this.mapToRadix.map(t).join("")+"]","g"),this._thousandsSeparatorRegExp=new RegExp(t(this.thousandsSeparator),"g")}_removeThousandsSeparators(t){return t.replace(this._thousandsSeparatorRegExp,"")}_insertThousandsSeparators(t){const s=t.split(this.radix);return s[0]=s[0].replace(/\B(?=(\d{3})+(?!\d))/g,this.thousandsSeparator),s.join(this.radix)}doPrepareChar(t,s){void 0===s&&(s={});const[e,a]=super.doPrepareChar(this._removeThousandsSeparators(this.scale&&this.mapToRadix.length&&(s.input&&s.raw||!s.input&&!s.raw)?t.replace(this._mapToRadixRegExp,this.radix):t),s);return t&&!e&&(a.skip=!0),!e||this.allowPositive||this.value||"-"===e||a.aggregate(this._appendChar("-")),[e,a]}_separatorsCount(t,s){void 0===s&&(s=!1);let e=0;for(let a=0;a<t;++a)this._value.indexOf(this.thousandsSeparator,a)===a&&(++e,s&&(t+=this.thousandsSeparator.length));return e}_separatorsCountFromSlice(t){return void 0===t&&(t=this._value),this._separatorsCount(this._removeThousandsSeparators(t).length,!0)}extractInput(t,s,e){return void 0===t&&(t=0),void 0===s&&(s=this.displayValue.length),[t,s]=this._adjustRangeWithSeparators(t,s),this._removeThousandsSeparators(super.extractInput(t,s,e))}_appendCharRaw(t,s){void 0===s&&(s={});const a=s.tail&&s._beforeTailState?s._beforeTailState._value:this._value,i=this._separatorsCountFromSlice(a);this._value=this._removeThousandsSeparators(this.value);const r=this._value;this._value+=t;const o=this.number;let n,u=!isNaN(o),l=!1;if(u){let t;null!=this.min&&this.min<0&&this.number<this.min&&(t=this.min),null!=this.max&&this.max>0&&this.number>this.max&&(t=this.max),null!=t&&(this.autofix?(this._value=this.format(t,this).replace(h.UNMASKED_RADIX,this.radix),l||(l=r===this._value&&!s.tail)):u=!1),u&&(u=Boolean(this._value.match(this._numberRegExp)))}u?n=new e({inserted:this._value.slice(r.length),rawInserted:l?"":t,skip:l}):(this._value=r,n=new e),this._value=this._insertThousandsSeparators(this._value);const p=s.tail&&s._beforeTailState?s._beforeTailState._value:this._value,d=this._separatorsCountFromSlice(p);return n.tailShift+=(d-i)*this.thousandsSeparator.length,n}_findSeparatorAround(t){if(this.thousandsSeparator){const s=t-this.thousandsSeparator.length+1,e=this.value.indexOf(this.thousandsSeparator,s);if(e<=t)return e}return-1}_adjustRangeWithSeparators(t,s){const e=this._findSeparatorAround(t);e>=0&&(t=e);const a=this._findSeparatorAround(s);return a>=0&&(s=a+this.thousandsSeparator.length),[t,s]}remove(t,s){void 0===t&&(t=0),void 0===s&&(s=this.displayValue.length),[t,s]=this._adjustRangeWithSeparators(t,s);const a=this.value.slice(0,t),i=this.value.slice(s),r=this._separatorsCount(a.length);this._value=this._insertThousandsSeparators(this._removeThousandsSeparators(a+i));const h=this._separatorsCountFromSlice(a);return new e({tailShift:(h-r)*this.thousandsSeparator.length})}nearestInputPos(t,e){if(!this.thousandsSeparator)return t;switch(e){case s.NONE:case s.LEFT:case s.FORCE_LEFT:{const a=this._findSeparatorAround(t-1);if(a>=0){const i=a+this.thousandsSeparator.length;if(t<i||this.value.length<=i||e===s.FORCE_LEFT)return a}break}case s.RIGHT:case s.FORCE_RIGHT:{const s=this._findSeparatorAround(t);if(s>=0)return s+this.thousandsSeparator.length}}return t}doCommit(){if(this.value){const t=this.number;let s=t;null!=this.min&&(s=Math.max(s,this.min)),null!=this.max&&(s=Math.min(s,this.max)),s!==t&&(this.unmaskedValue=this.format(s,this));let e=this.value;this.normalizeZeros&&(e=this._normalizeZeros(e)),this.padFractionalZeros&&this.scale>0&&(e=this._padFractionalZeros(e)),this._value=e}super.doCommit()}_normalizeZeros(t){const s=this._removeThousandsSeparators(t).split(this.radix);return s[0]=s[0].replace(/^(\D*)(0*)(\d*)/,((t,s,e,a)=>s+a)),t.length&&!/\d$/.test(s[0])&&(s[0]=s[0]+"0"),s.length>1&&(s[1]=s[1].replace(/0*$/,""),s[1].length||(s.length=1)),this._insertThousandsSeparators(s.join(this.radix))}_padFractionalZeros(t){if(!t)return t;const s=t.split(this.radix);return s.length<2&&s.push(""),s[1]=s[1].padEnd(this.scale,"0"),s.join(this.radix)}doSkipInvalid(t,s,e){void 0===s&&(s={});const a=0===this.scale&&t!==this.thousandsSeparator&&(t===this.radix||t===h.UNMASKED_RADIX||this.mapToRadix.includes(t));return super.doSkipInvalid(t,s,e)&&!a}get unmaskedValue(){return this._removeThousandsSeparators(this._normalizeZeros(this.value)).replace(this.radix,h.UNMASKED_RADIX)}set unmaskedValue(t){super.unmaskedValue=t}get typedValue(){return this.parse(this.unmaskedValue,this)}set typedValue(t){this.rawInputValue=this.format(t,this).replace(h.UNMASKED_RADIX,this.radix)}get number(){return this.typedValue}set number(t){this.typedValue=t}get allowNegative(){return null!=this.min&&this.min<0||null!=this.max&&this.max<0}get allowPositive(){return null!=this.min&&this.min>0||null!=this.max&&this.max>0}typedValueEquals(t){return(super.typedValueEquals(t)||h.EMPTY_VALUES.includes(t)&&h.EMPTY_VALUES.includes(this.typedValue))&&!(0===t&&""===this.value)}}r=h,h.UNMASKED_RADIX=".",h.EMPTY_VALUES=[...a.EMPTY_VALUES,0],h.DEFAULTS={...a.DEFAULTS,mask:Number,radix:",",thousandsSeparator:"",mapToRadix:[r.UNMASKED_RADIX],min:Number.MIN_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,scale:2,normalizeZeros:!0,padFractionalZeros:!1,parse:Number,format:t=>t.toLocaleString("en-US",{useGrouping:!1,maximumFractionDigits:20})},i.MaskedNumber=h;export{h as default};
